<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Add Map Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <title>Easy Go | Track Order</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Tracking Steps */
        .tracking-step { 
            transition: all 0.3s; 
            position: relative;
        }
        
        .tracking-step::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #e5e7eb;
            z-index: -1;
        }
        
        .tracking-step:last-child::after {
            display: none;
        }
        
        .tracking-step.active { 
            background-color: #10b981; 
            color: white; 
        }
        
        .tracking-step.completed { 
            background-color: #059669; 
            color: white; 
        }
        
        .tracking-step.active .step-icon,
        .tracking-step.completed .step-icon {
            background: white !important;
            color: #10b981 !important;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Firebase Status Indicator */
        .firebase-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        /* Real-time indicator */
        .real-time-indicator {
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Map Container */
        #map {
            height: 400px;
            border-radius: 1rem;
            z-index: 1;
        }
        
        /* Enhanced status badges */
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-confirmed { background: #dbeafe; color: #1e40af; }
        .badge-preparing { background: #ede9fe; color: #5b21b6; }
        .badge-ready { background: #d1fae5; color: #065f46; }
        .badge-out-for-delivery { background: #fef3c7; color: #92400e; }
        .badge-delivered { background: #d1fae5; color: #065f46; }
        .badge-cancelled { background: #fee2e2; color: #991b1b; }
        
        /* Rider Location Pulse */
        .rider-pulse {
            animation: rider-pulse 1.5s infinite;
        }
        
        @keyframes rider-pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* Loading Animation */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased bg-gray-50">

    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" class="firebase-status hidden">
        üîÑ Connecting...
    </div>

    <!-- Empty Order Overlay -->
    <div id="emptyOrderOverlay" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md mx-4">
            <div class="text-6xl mb-6">üì¶</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">No Active Order Found</h2>
            <p class="text-gray-600 mb-6">You don't have any active orders to track.</p>
            <p class="text-sm text-gray-500 mb-8">Redirecting to menu in <span id="redirect-countdown">5</span> seconds...</p>
            <a href="https://clean-scripts.github.io/Easygo-Menu/" 
               class="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold rounded-xl hover:opacity-90 transition">
                üõí Go to Menu Now
            </a>
        </div>
    </div>

    <header class="relative mb-8">
        <div class="h-40 overflow-hidden">
            <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/Banner.png" 
                 class="w-full h-full object-cover" alt="Easy Go Banner">
        </div>
        <div class="absolute -bottom-6 left-0 right-0 flex justify-center">
            <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                 class="h-20 w-20 rounded-full border-4 border-white shadow-xl bg-white p-1">
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 pt-10 pb-20">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-black uppercase mb-4">Track Your Order</h1>
            <p class="text-gray-600 flex items-center justify-center gap-2">
                <span class="real-time-indicator">‚óè</span> Live Tracking Active
            </p>
        </div>
        
        <!-- Order Status Badge -->
        <div class="mb-8 text-center">
            <div id="order-status-badge" class="inline-flex items-center gap-2 px-6 py-3 bg-yellow-100 text-yellow-800 rounded-full">
                <span class="text-xl">‚è≥</span>
                <span class="font-bold">Checking Order Status...</span>
            </div>
            <p class="text-sm text-gray-500 mt-2">Order ID: <span id="order-id-display" class="font-bold">--</span></p>
        </div>
        
        <!-- Tracking Steps -->
        <div class="flex flex-col md:flex-row justify-between mb-12 relative">
            <div id="step-1" class="tracking-step flex flex-col items-center p-6 rounded-2xl mb-4 md:mb-0">
                <div class="step-icon w-16 h-16 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-2xl mb-4">
                    üì¶
                </div>
                <p class="font-bold">Order Placed</p>
                <p class="text-sm">Order confirmed</p>
            </div>
            
            <div id="step-2" class="tracking-step flex flex-col items-center p-6 rounded-2xl mb-4 md:mb-0">
                <div class="step-icon w-16 h-16 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-2xl mb-4">
                    ‚è∞
                </div>
                <p class="font-bold">Restaurant</p>
                <p class="text-sm">Waiting...</p>
            </div>
            
            <div id="step-3" class="tracking-step flex flex-col items-center p-6 rounded-2xl mb-4 md:mb-0">
                <div class="step-icon w-16 h-16 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-2xl mb-4">
                    üë®‚Äçüç≥
                </div>
                <p class="font-bold">Preparing</p>
                <p class="text-sm">Food being prepared</p>
            </div>
            
            <div id="step-delivery" class="tracking-step flex flex-col items-center p-6 rounded-2xl mb-4 md:mb-0 hidden">
                <div class="step-icon w-16 h-16 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-2xl mb-4">
                    üõµ
                </div>
                <p class="font-bold">On the Way</p>
                <p class="text-sm">Out for delivery</p>
            </div>
            
            <div id="step-pickup" class="tracking-step flex flex-col items-center p-6 rounded-2xl mb-4 md:mb-0">
                <div class="step-icon w-16 h-16 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-2xl mb-4">
                    üè™
                </div>
                <p class="font-bold">Ready</p>
                <p class="text-sm">Order is ready</p>
            </div>
            
            <div id="step-5" class="tracking-step flex flex-col items-center p-6 rounded-2xl">
                <div class="step-icon w-16 h-16 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-2xl mb-4">
                    ‚úÖ
                </div>
                <p class="font-bold">Completed</p>
                <p class="text-sm">Order completed</p>
            </div>
        </div>
        
        <!-- Restaurant Acceptance Timer -->
        <div id="restaurant-timer" class="hidden mb-8">
            <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-6 text-center">
                <h3 class="font-bold text-yellow-800 mb-4 flex items-center justify-center gap-2">
                    <span class="text-xl">‚è∞</span>
                    Waiting for Restaurant Confirmation
                </h3>
                <p class="text-yellow-700 mb-4">
                    Restaurant has 2 minutes to accept your order. If not accepted, order will be automatically cancelled and refunded.
                </p>
                <div class="flex items-center justify-center gap-4">
                    <div class="w-full bg-yellow-100 rounded-full h-2">
                        <div id="timer-progress" class="bg-yellow-500 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <span id="timer-countdown" class="font-bold text-yellow-800">2:00</span>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <!-- Order Details -->
            <div>
                <div class="bg-white rounded-3xl shadow-lg p-8 mb-8">
                    <h2 class="text-2xl font-bold mb-6">üìã Order Details</h2>
                    
                    <div id="order-summary" class="space-y-4 mb-6">
                        <div class="flex items-center justify-center py-8">
                            <div class="loading-spinner"></div>
                            <span class="ml-3 text-gray-600">Loading order details...</span>
                        </div>
                    </div>
                    
                    <!-- OTP Section -->
                    <div id="otp-section" class="bg-green-50 border border-green-200 rounded-2xl p-6 hidden">
                        <h3 class="font-bold text-green-800 mb-4">üîê Delivery Verification OTP</h3>
                        <div class="text-center">
                            <p class="text-5xl font-bold text-green-600 mb-4" id="otp-display">XXXXXX</p>
                            <p class="text-green-700 mb-4">
                                Share this OTP with the delivery partner when your order arrives
                            </p>
                            <button id="share-otp" 
                                    class="px-6 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors">
                                üì§ Share OTP with Rider
                            </button>
                            <p class="text-xs text-green-600 mt-3">
                                ‚úÖ This OTP verifies that you received the order
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Customer Details -->
                <div class="bg-white rounded-3xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6">üë§ Your Details</h2>
                    <div id="customer-details" class="space-y-4">
                        <div class="flex items-center">
                            <div class="loading-spinner"></div>
                            <span class="ml-3 text-gray-600">Loading customer details...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Map Container & Status Updates -->
            <div>
                <div class="bg-white rounded-3xl shadow-lg p-8 mb-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center justify-between">
                        <span>üìç Live Tracking Map</span>
                        <span id="rider-status" class="text-sm font-normal text-gray-500"></span>
                    </h2>
                    <div id="map" class="relative">
                        <div class="absolute inset-0 flex items-center justify-center bg-gray-100 rounded-xl z-0" id="map-loading">
                            <div class="text-center p-4">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-xl font-bold mb-2">Loading Live Tracking...</p>
                                <p class="mb-4">Real-time rider location will appear here</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rider Info & Controls -->
                    <div id="rider-info-section" class="hidden mt-6 p-6 bg-blue-50 rounded-xl">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-blue-800">Delivery Partner</p>
                                <p id="delivery-partner-name" class="text-xl font-black text-blue-600">--</p>
                                <p class="text-sm text-blue-600 mt-2">Live Tracking Active</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-blue-600">Estimated Arrival</p>
                                <p id="eta" class="text-3xl font-black text-blue-600">-- min</p>
                                <div class="mt-4">
                                    <button id="call-rider" 
                                            class="inline-flex items-center gap-3 px-6 py-3 bg-white border-2 border-blue-200 rounded-xl shadow hover:shadow-blue-100 hover:border-blue-500 transition-all duration-300">
                                        <div class="bg-blue-600 p-2 rounded-full">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                            </svg>
                                        </div>
                                        <span class="font-bold text-gray-900">Call Rider</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delivery Status Timeline -->
                    <div id="delivery-timeline" class="hidden mt-6 space-y-3">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                                <span class="text-green-600">üõµ</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium">Rider Assigned</p>
                                <p class="text-sm text-gray-500" id="rider-assigned-time">--</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                                <span class="text-gray-400">üè™</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium">Arrived at Restaurant</p>
                                <p class="text-sm text-gray-500" id="arrived-restaurant-time">--</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                                <span class="text-gray-400">üì¶</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium">Order Picked Up</p>
                                <p class="text-sm text-gray-500" id="picked-up-time">--</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                                <span class="text-gray-400">üìç</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium">Arrived at Your Location</p>
                                <p class="text-sm text-gray-500" id="arrived-customer-time">--</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Order Status Updates -->
                <div class="bg-white rounded-3xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6">üîÑ Real-time Updates</h2>
                    <div id="status-updates" class="space-y-4 max-h-96 overflow-y-auto">
                        <div class="flex items-center">
                            <div class="loading-spinner"></div>
                            <span class="ml-3 text-gray-600">Waiting for updates...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- After Delivery Section -->
        <div id="after-delivery" class="hidden">
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-3xl shadow-lg p-12 text-center text-white">
                <div class="text-6xl mb-6">üéâ</div>
                <h2 class="text-3xl font-bold mb-4">Order Delivered Successfully!</h2>
                <p class="text-xl mb-8">Hope you enjoyed your meal. Please share your feedback with us.</p>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="https://www.google.com/maps/place/EasyGo/@22.7767506,75.9581962,17z/data=!3m1!4b1!4m6!3m5!1s0x39631d1e6d09fbb7:0x417f2409ea954602!8m2!3d22.7767506!4d75.9607711!16s%2Fg%2F11yt0fxskh?authuser=1&entry=ttu&g_ep=EgoyMDI5MTIwOS.0IKXMDSoKLDEwMDc5MjA3M0gBUAM%3D" 
                       target="_blank"
                       class="px-8 py-4 bg-white text-green-600 font-bold rounded-2xl hover:bg-gray-100 transition-colors">
                        ‚≠ê Rate us on Google
                    </a>
                    
                    <a href="https://clean-scripts.github.io/Easygo-Menu/" 
                       class="px-8 py-4 bg-transparent border-2 border-white text-white font-bold rounded-2xl hover:bg-white/10 transition-colors">
                        üõí Order Again
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Order Cancelled Section -->
        <div id="order-cancelled" class="hidden">
            <div class="bg-gradient-to-r from-red-500 to-pink-600 rounded-3xl shadow-lg p-12 text-center text-white">
                <div class="text-6xl mb-6">üò¢</div>
                <h2 class="text-3xl font-bold mb-4">Order Not Accepted</h2>
                <p class="text-xl mb-6">We're sorry, but we couldn't accept your order at this time.</p>
                
                <div class="bg-white/20 rounded-2xl p-6 max-w-md mx-auto mb-8">
                    <p class="font-bold mb-2">üí∏ Refund Information:</p>
                    <p>Your payment will be refunded within 5 working days.</p>
                    <p class="text-sm mt-2">Amount will appear in your account automatically.</p>
                </div>
                
                <a href="https://clean-scripts.github.io/Easygo-Menu/" 
                   class="px-8 py-4 bg-white text-red-600 font-bold rounded-2xl hover:bg-gray-100 transition-colors">
                    üõçÔ∏è Try Ordering Again
                </a>
            </div>
        </div>
        
        <!-- Rider Waiting Charges Info -->
        <div id="waiting-charges-info" class="hidden mt-8 bg-orange-50 border border-orange-200 rounded-2xl p-6">
            <h3 class="font-bold text-orange-800 mb-4 flex items-center gap-2">
                <span>‚è∞</span> Rider Waiting Charges Active
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 bg-white rounded-xl">
                    <p class="font-medium text-orange-700">At Restaurant:</p>
                    <p class="text-sm text-orange-600">Rider waiting more than 2 minutes: <span class="font-bold">‚Çπ1 per 30 sec</span></p>
                    <p class="text-xs text-orange-500">Paid by restaurant</p>
                </div>
                <div class="p-4 bg-white rounded-xl">
                    <p class="font-medium text-orange-700">At Your Location:</p>
                    <p class="text-sm text-orange-600">Rider waiting more than 100 sec: <span class="font-bold">‚Çπ2 per 60 sec</span></p>
                    <p class="text-xs text-orange-500">Paid by customer</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                             class="h-12 w-12 rounded-full bg-white p-1 mr-3">
                        <div>
                            <h2 class="text-xl font-bold">Easy Go</h2>
                            <p class="text-gray-400 text-sm">Delivering Freshness & Speed !</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-gray-400 text-sm mb-2">
                        ¬© 2024 Easy Go | All Rights Reserved
                    </p>
                    <div class="mt-4">
                        <a href="https://clean-scripts.github.io/Easygo-Menu/" class="text-gray-400 hover:text-white text-sm mr-4">View Menu</a>
                        <a href="https://clean-scripts.github.io/Easygo-Privacy/" class="text-gray-400 hover:text-white text-sm mr-4">Privacy Policy</a>
                        <a href="https://clean-scripts.github.io/Easygo-Terms/" class="text-gray-400 hover:text-white text-sm">Terms & Conditions</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Firebase JavaScript -->
    <script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
        apiKey: "AIzaSyCU_wJYBTwEwMZQ-iTYOjUZuEHEphA0DXc",
        authDomain: "easygo-10f4b.firebaseapp.com",
        projectId: "easygo-10f4b",
        storageBucket: "easygo-10f4b.firebasestorage.app",
        messagingSenderId: "197660067542",
        appId: "1:197660067542:web:6c616efb479b122f1f6b77",
        databaseURL: "https://easygo-10f4b-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    // Firebase variables
    let database;
    let isFirebaseConnected = false;
    let orderListener = null;
    let currentOrderId = null;
    let map;
    let riderMarker;
    let routePolyline;
    let restaurantTimerInterval;
    let restaurantTimerCountdown = 120; // 2 minutes in seconds

    // Restaurant location
    const RESTAURANT_LOCATION = {
        lat: 22.7767737,
        lng: 75.9605483,
        address: "Prime Square, Omaxe City 1, Indore"
    };

    // ==================== FIREBASE INITIALIZATION ====================
    function initializeFirebase() {
        try {
            const app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            
            // Monitor connection status
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", function(snap) {
                const statusElement = document.getElementById('firebaseStatus');
                
                if (snap.val() === true) {
                    isFirebaseConnected = true;
                    statusElement.textContent = "‚úÖ Connected to Database";
                    statusElement.className = "firebase-status bg-green-500 text-white";
                    
                    // Hide status after 3 seconds
                    setTimeout(() => {
                        statusElement.classList.add('hidden');
                    }, 3000);
                } else {
                    isFirebaseConnected = false;
                    statusElement.textContent = "‚ùå Database Disconnected";
                    statusElement.className = "firebase-status bg-red-500 text-white";
                    statusElement.classList.remove('hidden');
                }
            });
            
            // Show initial connecting status
            const statusElement = document.getElementById('firebaseStatus');
            statusElement.classList.remove('hidden');
            statusElement.textContent = "üîÑ Connecting to Database...";
            statusElement.className = "firebase-status bg-yellow-500 text-white";
            
        } catch (error) {
            console.error("Firebase initialization error:", error);
            document.getElementById('firebaseStatus').classList.add('hidden');
        }
    }

    // ==================== ORDER DATA FUNCTIONS ====================
    function getOrderIdFromLocalStorage() {
        // First check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const orderParam = urlParams.get('order');
        if (orderParam) {
            localStorage.setItem('easygo-order-id', orderParam);
            return orderParam;
        }
        
        // Then check localStorage for order ID
        const orderId = localStorage.getItem('easygo-order-id');
        return orderId;
    }

    // ==================== REAL-TIME ORDER LISTENER ====================
    function setupOrderListener(orderId) {
        if (!orderId || !isFirebaseConnected) {
            console.error("Cannot setup listener: No order ID or Firebase disconnected");
            return false;
        }
        
        currentOrderId = orderId;
        
        // Remove existing listener if any
        if (orderListener) {
            orderListener.off();
        }
        
        // Setup real-time listener
        orderListener = database.ref(`orders/${orderId}`).on('value', (snapshot) => {
            const orderData = snapshot.val();
            
            if (orderData) {
                // Update UI with real-time data
                updateOrderUI(orderData);
                
                // Save to localStorage for backup
                localStorage.setItem('easygo-last-order', JSON.stringify(orderData));
                
            } else {
                // Order not found in Firebase
                showEmptyOrderOverlay();
            }
        }, (error) => {
            console.error("Firebase listener error:", error);
        });
        
        return true;
    }

    // ==================== MAP FUNCTIONS ====================
    function initMap(orderData) {
        if (!map) {
            // Initialize map centered on restaurant
            map = L.map('map').setView([RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Hide loading overlay
            document.getElementById('map-loading').style.display = 'none';
        }
        
        // Clear existing markers and route
        if (riderMarker) map.removeLayer(riderMarker);
        if (routePolyline) map.removeLayer(routePolyline);
        
        // Add restaurant marker
        L.marker([RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng])
            .addTo(map)
            .bindPopup('<b>EasyGo Restaurant</b><br>üìç Pickup Location')
            .openPopup();
        
        // Add rider marker if rider location is available
        if (orderData.riderLocation) {
            updateRiderLocation(orderData.riderLocation.lat, orderData.riderLocation.lng);
        }
    }

    function updateRiderLocation(lat, lng) {
        if (!map) return;
        
        // Create or update rider marker
        if (!riderMarker) {
            riderMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'rider-marker',
                    html: '<div class="rider-pulse" style="background-color: #3b82f6; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);">üõµ</div>',
                    iconSize: [40, 40]
                })
            }).addTo(map)
            .bindPopup('<b>Delivery Partner</b><br>üõµ Live Location');
        } else {
            riderMarker.setLatLng([lat, lng]);
        }
    }

    // ==================== RESTAURANT ACCEPTANCE TIMER ====================
    function startRestaurantAcceptanceTimer() {
        // Show timer section
        document.getElementById('restaurant-timer').classList.remove('hidden');
        
        // Start countdown
        restaurantTimerInterval = setInterval(() => {
            restaurantTimerCountdown--;
            
            // Update timer display
            const minutes = Math.floor(restaurantTimerCountdown / 60);
            const seconds = restaurantTimerCountdown % 60;
            document.getElementById('timer-countdown').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Update progress bar
            const progress = ((120 - restaurantTimerCountdown) / 120) * 100;
            document.getElementById('timer-progress').style.width = `${progress}%`;
            
            // If timer reaches 0, auto-cancel order
            if (restaurantTimerCountdown <= 0) {
                clearInterval(restaurantTimerInterval);
                autoCancelOrder();
            }
        }, 1000);
    }

    function stopRestaurantTimer() {
        if (restaurantTimerInterval) {
            clearInterval(restaurantTimerInterval);
            document.getElementById('restaurant-timer').classList.add('hidden');
        }
    }

    function autoCancelOrder() {
        if (!currentOrderId) return;
        
        const cancelUpdates = {
            status: 'cancelled',
            cancelledAt: Date.now(),
            cancelReason: 'Auto-cancelled: Restaurant did not accept within 2 minutes',
            updatedAt: Date.now()
        };
        
        database.ref('orders/' + currentOrderId).update(cancelUpdates)
            .then(() => {
                showNotification('Order auto-cancelled. Refund will be initiated automatically.');
            })
            .catch(error => {
                console.error("Error auto-cancelling order:", error);
            });
    }

    // ==================== UI UPDATE FUNCTIONS ====================
    function updateOrderUI(orderData) {
        // Display order ID
        document.getElementById('order-id-display').textContent = orderData.orderId || currentOrderId;
        
        // Update OTP
        if (orderData.otp) {
            document.getElementById('otp-display').textContent = orderData.otp;
            document.getElementById('otp-section').classList.remove('hidden');
        }
        
        // Update order summary
        updateOrderSummary(orderData);
        
        // Update customer details
        updateCustomerDetails(orderData);
        
        // Update delivery partner info
        if (orderData.riderId || orderData.deliveryPartner) {
            updateDeliveryPartnerInfo(orderData);
        }
        
        // Update status and tracking steps
        updateOrderStatus(orderData.status, orderData);
        
        // Add status update to timeline
        addStatusUpdate(orderData);
        
        // Update delivery timeline
        updateDeliveryTimeline(orderData);
        
        // Handle restaurant acceptance timer
        handleRestaurantTimer(orderData);
        
        // Handle completed/cancelled orders
        if (orderData.status === 'delivered') {
            showDeliveredMessage();
        } else if (orderData.status === 'cancelled') {
            showCancelledMessage();
        }
        
        // Initialize or update map
        initMap(orderData);
    }

    function updateDeliveryPartnerInfo(orderData) {
        if (orderData.deliveryPartner) {
            document.getElementById('delivery-partner-name').textContent = orderData.deliveryPartner;
            document.getElementById('rider-status').textContent = orderData.riderStatus || 'On the way';
            
            // Show rider info section
            document.getElementById('rider-info-section').classList.remove('hidden');
            
            // Setup call button
            document.getElementById('call-rider').onclick = function() {
                if (orderData.deliveryPartnerPhone) {
                    window.open(`tel:${orderData.deliveryPartnerPhone}`, '_blank');
                } else {
                    window.open('tel:+917651837322', '_blank');
                }
            };
            
            // Update ETA
            let eta = '25-30 min';
            if (orderData.eta) {
                eta = orderData.eta;
            } else if (orderData.status === 'out-for-delivery') {
                eta = '15-20 min';
            }
            document.getElementById('eta').textContent = eta;
        }
    }

    function updateDeliveryTimeline(orderData) {
        if (orderData.deliveryMode === 'delivery') {
            document.getElementById('delivery-timeline').classList.remove('hidden');
            
            // Update timeline times
            if (orderData.deliveryAssignedAt) {
                document.getElementById('rider-assigned-time').textContent = 
                    new Date(orderData.deliveryAssignedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                document.querySelector('#delivery-timeline .flex:nth-child(1) .w-8').classList.replace('bg-gray-100', 'bg-green-100');
                document.querySelector('#delivery-timeline .flex:nth-child(1) span').classList.replace('text-gray-400', 'text-green-600');
            }
            
            if (orderData.riderArrivedAt) {
                document.getElementById('arrived-restaurant-time').textContent = 
                    new Date(orderData.riderArrivedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                document.querySelector('#delivery-timeline .flex:nth-child(2) .w-8').classList.replace('bg-gray-100', 'bg-green-100');
                document.querySelector('#delivery-timeline .flex:nth-child(2) span').classList.replace('text-gray-400', 'text-green-600');
                
                // Show waiting charges info if waiting time exceeded
                if (orderData.waitingBonus && orderData.waitingBonus > 0) {
                    document.getElementById('waiting-charges-info').classList.remove('hidden');
                }
            }
            
            if (orderData.pickedUpAt) {
                document.getElementById('picked-up-time').textContent = 
                    new Date(orderData.pickedUpAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                document.querySelector('#delivery-timeline .flex:nth-child(3) .w-8').classList.replace('bg-gray-100', 'bg-green-100');
                document.querySelector('#delivery-timeline .flex:nth-child(3) span').classList.replace('text-gray-400', 'text-green-600');
            }
            
            if (orderData.riderArrivedCustomerAt) {
                document.getElementById('arrived-customer-time').textContent = 
                    new Date(orderData.riderArrivedCustomerAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                document.querySelector('#delivery-timeline .flex:nth-child(4) .w-8').classList.replace('bg-gray-100', 'bg-green-100');
                document.querySelector('#delivery-timeline .flex:nth-child(4) span').classList.replace('text-gray-400', 'text-green-600');
            }
        }
    }

    function handleRestaurantTimer(orderData) {
        if (orderData.status === 'pending' || orderData.status === 'confirmed') {
            startRestaurantAcceptanceTimer();
        } else {
            stopRestaurantTimer();
        }
    }

    function updateOrderStatus(status, orderData) {
        const statusMap = {
            'pending': { 
                step: 1, 
                badge: 'Order Received - Pending', 
                badgeColor: 'badge-pending', 
                badgeIcon: 'üì¶',
                eta: 'Processing...'
            },
            'confirmed': { 
                step: 2, 
                badge: 'Order Confirmed - Waiting Restaurant', 
                badgeColor: 'badge-confirmed', 
                badgeIcon: '‚è∞',
                eta: 'Waiting restaurant...'
            },
            'preparing': { 
                step: 3, 
                badge: 'Preparing Your Order', 
                badgeColor: 'badge-preparing', 
                badgeIcon: 'üë®‚Äçüç≥',
                eta: '20-25 min'
            },
            'ready': { 
                step: 4, 
                badge: orderData.deliveryMode === 'delivery' ? 'Ready for Delivery' : 'Ready for Pickup',
                badgeColor: 'badge-ready', 
                badgeIcon: '‚úÖ',
                eta: orderData.deliveryMode === 'delivery' ? 'Finding rider...' : 'Ready Now'
            },
            'out-for-delivery': { 
                step: 4, 
                badge: 'Out for Delivery', 
                badgeColor: 'badge-out-for-delivery', 
                badgeIcon: 'üõµ',
                eta: '15-20 min'
            },
            'delivered': { 
                step: 5, 
                badge: 'Order Delivered', 
                badgeColor: 'badge-delivered', 
                badgeIcon: '‚úÖ',
                eta: 'Arrived'
            },
            'cancelled': { 
                step: 0, 
                badge: 'Order Cancelled', 
                badgeColor: 'badge-cancelled', 
                badgeIcon: '‚ùå',
                eta: 'N/A'
            }
        };
        
        const statusInfo = statusMap[status] || statusMap['pending'];
        
        // Update badge
        const badge = document.getElementById('order-status-badge');
        badge.className = `inline-flex items-center gap-2 px-6 py-3 ${statusInfo.badgeColor} rounded-full`;
        badge.innerHTML = `<span class="text-xl">${statusInfo.badgeIcon}</span><span class="font-bold">${statusInfo.badge}</span>`;
        
        // Update tracking steps
        updateTrackingSteps(statusInfo.step, status);
        
        return statusInfo;
    }

    function updateTrackingSteps(activeStep, status) {
        const steps = document.querySelectorAll('.tracking-step');
        
        // Show/hide delivery step based on order type
        const isDelivery = status === 'out-for-delivery';
        
        if (isDelivery) {
            document.getElementById('step-delivery').classList.remove('hidden');
            document.getElementById('step-pickup').classList.add('hidden');
        } else {
            document.getElementById('step-delivery').classList.add('hidden');
            document.getElementById('step-pickup').classList.remove('hidden');
        }
        
        // Update step colors
        steps.forEach((step, index) => {
            const stepDiv = step.querySelector('.step-icon');
            stepDiv.classList.remove('bg-green-500', 'bg-gray-100', 'text-white', 'text-gray-400');
            
            if (index < activeStep) {
                stepDiv.classList.add('bg-green-500', 'text-white');
                step.classList.add('completed');
                step.classList.remove('active');
            } else if (index === activeStep) {
                stepDiv.classList.add('bg-green-500', 'text-white');
                step.classList.add('active');
                step.classList.remove('completed');
            } else {
                stepDiv.classList.add('bg-gray-100', 'text-gray-400');
                step.classList.remove('active', 'completed');
            }
        });
    }

    function updateOrderSummary(orderData) {
        const container = document.getElementById('order-summary');
        
        if (orderData.items && orderData.items.length > 0) {
            let html = '';
            let subtotal = 0;
            
            orderData.items.forEach(item => {
                const quantity = parseInt(item.quantity) || 1;
                const unitPrice = parseFloat(item.unitPrice) || 0;
                const totalPrice = unitPrice * quantity;
                subtotal += totalPrice;
                
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <p class="font-medium">${item.name || 'Food Item'}</p>
                            <p class="text-sm text-gray-600">Quantity: ${quantity} √ó ${getPackName(item.pack)}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold">‚Çπ${totalPrice.toFixed(2)}</p>
                            <p class="text-sm text-gray-500">‚Çπ${unitPrice.toFixed(2)} each</p>
                        </div>
                    </div>
                `;
            });
            
            const total = parseFloat(orderData.totalAmount) || subtotal;
            const deliveryCharge = orderData.deliveryCharge || (orderData.deliveryMode === 'delivery' ? 49 : 0);
            const platformFee = total * 0.05;
            const gstOnPlatform = platformFee * 0.18;
            
            html += `
                <div class="border-t pt-4 mt-4 space-y-2">
                    <div class="flex justify-between">
                        <span>Subtotal:</span>
                        <span>‚Çπ${subtotal.toFixed(2)}</span>
                    </div>
                    ${orderData.deliveryMode === 'delivery' ? `
                        <div class="flex justify-between">
                            <span>Delivery Charge:</span>
                            <span>‚Çπ${deliveryCharge.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    ${orderData.deliveryMode === 'delivery' ? `
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>Platform Fee (5%):</span>
                            <span>‚Çπ${platformFee.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>GST on Platform (18%):</span>
                            <span>‚Çπ${gstOnPlatform.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>Rider Earnings:</span>
                            <span>‚Çπ${(platformFee + gstOnPlatform).toFixed(2)}</span>
                        </div>
                    ` : ''}
                    <div class="flex justify-between items-center pt-3 border-t">
                        <span class="font-bold text-lg">Total Amount</span>
                        <span class="font-bold text-2xl text-green-600">‚Çπ${total.toFixed(2)}</span>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p class="text-gray-500">No order items found</p>';
        }
    }

    function updateCustomerDetails(orderData) {
        const container = document.getElementById('customer-details');
        
        let html = `
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-gray-600">Name:</span>
                    <span class="font-bold">${orderData.customerName || orderData.name || '--'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Phone:</span>
                    <span class="font-bold">${orderData.customerPhone || orderData.phone || '--'}</span>
                </div>
        `;
        
        if (orderData.address) {
            html += `
                <div class="flex justify-between">
                    <span class="text-gray-600">Address:</span>
                    <span class="font-bold text-right">${orderData.address.substring(0, 40)}...</span>
                </div>
            `;
        }
        
        html += `
                <div class="flex justify-between">
                    <span class="text-gray-600">Order Type:</span>
                    <span class="font-bold">${orderData.deliveryMode === 'delivery' ? 'üõµ Home Delivery' : 'üè™ Takeaway'}</span>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }

    function addStatusUpdate(orderData) {
        const updatesContainer = document.getElementById('status-updates');
        const status = orderData.status;
        const timestamp = orderData.lastUpdated || Date.now();
        
        // Clear loading message
        if (updatesContainer.querySelector('.loading-spinner')) {
            updatesContainer.innerHTML = '';
        }
        
        const messages = {
            'pending': { 
                title: 'Order Received', 
                message: 'Order received and waiting for restaurant confirmation', 
                icon: 'üì¶', 
                color: 'bg-yellow-500' 
            },
            'confirmed': { 
                title: 'Payment Confirmed', 
                message: 'Payment received and order confirmed to restaurant', 
                icon: '‚úÖ', 
                color: 'bg-green-500' 
            },
            'preparing': { 
                title: 'Food Preparation Started', 
                message: 'Chef is preparing your delicious food', 
                icon: 'üë®‚Äçüç≥', 
                color: 'bg-blue-500' 
            },
            'ready': { 
                title: 'Ready for Pickup/Delivery', 
                message: orderData.deliveryMode === 'delivery' ? 
                    'Order ready! Looking for delivery partner...' : 
                    'Your order is ready for pickup at restaurant', 
                icon: '‚úÖ', 
                color: 'bg-green-500' 
            },
            'out-for-delivery': { 
                title: 'Out for Delivery', 
                message: orderData.deliveryPartner ? 
                    `${orderData.deliveryPartner} is on the way!` : 
                    'Delivery partner assigned and on the way', 
                icon: 'üõµ', 
                color: 'bg-purple-500' 
            },
            'delivered': { 
                title: 'Order Delivered', 
                message: 'Your order has been delivered successfully', 
                icon: '‚úÖ', 
                color: 'bg-green-500' 
            },
            'cancelled': { 
                title: 'Order Cancelled', 
                message: 'Your order has been cancelled. Refund initiated', 
                icon: '‚ùå', 
                color: 'bg-red-500' 
            }
        };
        
        const message = messages[status];
        if (message) {
            const time = new Date(timestamp).toLocaleTimeString('en-IN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Check if this status already exists
            const existingUpdates = updatesContainer.querySelectorAll('.status-entry');
            const alreadyExists = Array.from(existingUpdates).some(update => 
                update.textContent.includes(message.title)
            );
            
            if (!alreadyExists) {
                const updateHTML = `
                    <div class="status-entry flex items-start gap-4">
                        <div class="w-8 h-8 rounded-full ${message.color} flex items-center justify-center text-white">
                            ${message.icon}
                        </div>
                        <div>
                            <p class="font-bold">${message.title}</p>
                            <p class="text-sm text-gray-600">${message.message}</p>
                            <p class="text-xs text-gray-500">${time}</p>
                        </div>
                    </div>
                `;
                
                // Add to top
                updatesContainer.insertAdjacentHTML('afterbegin', updateHTML);
                
                // Limit to 10 updates
                const updates = updatesContainer.querySelectorAll('.status-entry');
                if (updates.length > 10) {
                    updates[updates.length - 1].remove();
                }
            }
        }
    }

    function getPackName(pack) {
        const names = {
            'piece': 'Piece',
            'standard': 'Standard',
            'family': 'Family Pack',
            'xl': 'Extra Large'
        };
        return names[pack] || pack || 'Standard';
    }

    function showNotification(message) {
        // Create a simple notification
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-xl shadow-lg z-50';
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // ==================== COMPLETED/CANCELLED MESSAGES ====================
    function showDeliveredMessage() {
        document.getElementById('after-delivery').classList.remove('hidden');
        
        // Stop listening after delivery
        if (orderListener) {
            orderListener.off();
        }
        
        // Stop restaurant timer
        stopRestaurantTimer();
    }

    function showCancelledMessage() {
        document.getElementById('order-cancelled').classList.remove('hidden');
        
        // Stop listening after cancellation
        if (orderListener) {
            orderListener.off();
        }
        
        // Stop restaurant timer
        stopRestaurantTimer();
    }

    function showEmptyOrderOverlay() {
        document.getElementById('emptyOrderOverlay').classList.remove('hidden');
        
        // Hide main content
        document.querySelector('.max-w-6xl').style.display = 'none';
        document.querySelector('footer').style.display = 'none';
        document.querySelector('header').style.display = 'none';
        
        // Start countdown
        let seconds = 5;
        const countdownElement = document.getElementById('redirect-countdown');
        countdownElement.textContent = seconds;
        
        const countdown = setInterval(() => {
            seconds--;
            countdownElement.textContent = seconds;
            
            if (seconds <= 0) {
                clearInterval(countdown);
                window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/';
            }
        }, 1000);
    }

    // ==================== SHARE OTP FUNCTION ====================
    document.getElementById('share-otp').addEventListener('click', function() {
        const otp = document.getElementById('otp-display').textContent;
        const orderId = document.getElementById('order-id-display').textContent;
        
        if (!otp || otp === 'XXXXXX') {
            alert('OTP not available yet. Please wait for order confirmation.');
            return;
        }
        
        const message = `‚úÖ *EASYGO DELIVERY OTP* ‚úÖ%0A%0AOrder ID: ${orderId}%0AOTP: ${otp}%0A%0APlease share this OTP with the delivery partner when your order arrives.`;
        
        window.open(`https://wa.me/?text=${message}`, '_blank');
        
        alert('OTP ready to share! WhatsApp will open with OTP details.');
    });

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('EasyGo Track Page - Loading...');
        
        // Get order ID
        const orderId = getOrderIdFromLocalStorage();
        
        // Check if we have an order ID
        if (!orderId) {
            // Check for empty cart only if no order ID
            const cartItems = JSON.parse(localStorage.getItem('easygo-cart')) || [];
            if (cartItems.length === 0) {
                document.body.innerHTML = `
                    <div style="
                        height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-direction: column;
                        padding: 20px;
                        text-align: center;
                        font-family: system-ui, -apple-system, sans-serif;
                    ">
                        <div style="font-size: 48px; margin-bottom: 20px;">üõí</div>
                        <h2 style="margin-bottom: 10px; color: #333;">Your cart is empty</h2>
                        <p style="color: #666; margin-bottom: 30px;">Redirecting to menu...</p>
                        <div style="width: 200px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                            <div style="height: 100%; background: #10b981; width: 0%; transition: width 2s linear;"></div>
                        </div>
                    </div>
                `;
                
                // Animate progress bar
                setTimeout(() => {
                    document.querySelector('div[style*="width: 0%"]').style.width = '100%';
                }, 100);
                
                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/';
                }, 2000);
                return;
            }
        }
        
        // Initialize Firebase
        initializeFirebase();
        
        // Wait for Firebase connection, then load order
        const checkConnection = setInterval(() => {
            if (isFirebaseConnected) {
                clearInterval(checkConnection);
                loadOrderData();
            }
        }, 500);
        
        // Fallback: Load order after 3 seconds even if Firebase not connected
        setTimeout(() => {
            if (!isFirebaseConnected) {
                console.warn('Firebase not connected, using localStorage fallback');
                loadOrderDataFromLocalStorage();
            }
        }, 3000);
    });

    function loadOrderData() {
        const orderId = getOrderIdFromLocalStorage();
        
        if (!orderId) {
            console.log('No order ID found');
            showEmptyOrderOverlay();
            return;
        }
        
        console.log('Loading order:', orderId);
        
        // Show order ID immediately
        document.getElementById('order-id-display').textContent = orderId;
        
        // Setup real-time listener
        const listenerSet = setupOrderListener(orderId);
        
        if (!listenerSet) {
            // Fallback to loading from localStorage
            loadOrderDataFromLocalStorage();
        }
    }

    function loadOrderDataFromLocalStorage() {
        const orderData = JSON.parse(localStorage.getItem('easygo-last-order') || 'null');
        const orderId = localStorage.getItem('easygo-order-id');
        
        if (!orderData && !orderId) {
            showEmptyOrderOverlay();
            return;
        }
        
        if (orderData) {
            updateOrderUI(orderData);
        } else {
            // Minimal UI with just order ID
            document.getElementById('order-id-display').textContent = orderId;
            document.getElementById('order-status-badge').innerHTML = 
                `<span class="text-xl">‚è≥</span><span class="font-bold">Connecting to server...</span>`;
        }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (orderListener) {
            orderListener.off();
        }
        if (restaurantTimerInterval) {
            clearInterval(restaurantTimerInterval);
        }
    });

    // For debugging/testing
    window.simulateStatusUpdate = function(status) {
        const orderId = getOrderIdFromLocalStorage();
        if (!orderId) {
            alert('No order ID found');
            return;
        }
        
        if (isFirebaseConnected) {
            const updates = {
                status: status,
                lastUpdated: Date.now()
            };
            
            if (status === 'confirmed') {
                updates.confirmedAt = Date.now();
            }
            if (status === 'preparing') {
                updates.preparingAt = Date.now();
            }
            if (status === 'ready') {
                updates.readyAt = Date.now();
            }
            
            database.ref(`orders/${orderId}`).update(updates);
            alert(`Status updated to: ${status}`);
        } else {
            alert('Firebase not connected');
        }
    };
    
    // Simulate rider location (for testing)
    window.simulateRiderLocation = function() {
        const orderId = getOrderIdFromLocalStorage();
        if (!orderId || !isFirebaseConnected) {
            alert('No order or Firebase not connected');
            return;
        }
        
        // Simulate random location near restaurant
        const lat = RESTAURANT_LOCATION.lat + (Math.random() - 0.5) * 0.01;
        const lng = RESTAURANT_LOCATION.lng + (Math.random() - 0.5) * 0.01;
        
        database.ref(`orders/${orderId}`).update({
            riderLocation: { lat, lng },
            riderStatus: 'On the way',
            lastUpdated: Date.now()
        });
        
        alert(`Simulated rider location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
    };
    </script>
</body>
</html>
