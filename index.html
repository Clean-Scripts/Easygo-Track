<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <title>EasyGo | Order Tracking</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        #map { height: 300px; border-radius: 1rem; }
        .status-pending { border-left: 4px solid #f59e0b; }
        .status-confirmed { border-left: 4px solid #3b82f6; }
        .status-preparing { border-left: 4px solid #8b5cf6; }
        .status-ready { border-left: 4px solid #10b981; }
        .status-out-for-delivery { border-left: 4px solid #f59e0b; }
        .status-delivered { border-left: 4px solid #10b981; }
        .status-cancelled { border-left: 4px solid #ef4444; }
        
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.5s ease;
        }
        
        .timeline-step {
            position: relative;
            padding-left: 40px;
            margin-bottom: 20px;
        }
        .timeline-step.active .timeline-icon {
            background: #10b981;
            color: white;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }
        .timeline-step.completed .timeline-icon {
            background: #10b981;
            color: white;
        }
        .timeline-step.pending .timeline-icon {
            background: #e5e7eb;
            color: #6b7280;
        }
        .timeline-icon {
            position: absolute;
            left: 0;
            top: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        .timeline-line {
            position: absolute;
            left: 16px;
            top: 32px;
            bottom: -20px;
            width: 2px;
            background: #e5e7eb;
        }
        .timeline-step:last-child .timeline-line {
            display: none;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .firebase-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }
        
        .rider-marker {
            background: #3b82f6;
            color: white;
            padding: 5px 10px;
            border-radius: 50%;
            font-weight: bold;
            animation: riderMove 2s infinite alternate;
        }
        @keyframes riderMove {
            0% { transform: translateY(0); }
            100% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="antialiased bg-gray-100 min-h-screen">

    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" class="firebase-status hidden">
        üîÑ Connecting to Firebase...
    </div>

    <!-- Order Tracking Page -->
    <div id="tracking-section" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-4xl mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                             class="h-12 w-12 rounded-full">
                        <div>
                            <h1 class="text-2xl font-bold">EasyGo Order Tracking</h1>
                            <p class="text-gray-600">Real-time order tracking and updates</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p id="current-time" class="font-bold text-gray-800"></p>
                        <p class="text-sm text-gray-600">Live Tracking</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-4xl mx-auto px-4 py-8">
            <!-- Order Status Card -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold" id="order-id">Order #</h2>
                        <p class="text-gray-600" id="order-time"></p>
                    </div>
                    <div class="text-right">
                        <p class="text-3xl font-bold text-green-600" id="order-amount">‚Çπ0</p>
                        <span id="order-status-badge" class="inline-block px-3 py-1 rounded-full text-sm font-bold bg-yellow-100 text-yellow-800">
                            Loading...
                        </span>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mb-8">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm font-medium">Order Progress</span>
                        <span class="text-sm font-bold" id="progress-text">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-bold mb-4">üìã Order Timeline</h3>
                        <div id="order-timeline" class="space-y-4">
                            <!-- Timeline steps will be loaded here -->
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-bold mb-4">üöö Delivery Info</h3>
                        <div id="delivery-info" class="space-y-4">
                            <!-- Delivery info will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Live Tracking Section -->
            <div id="live-tracking-section" class="hidden">
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-6">üìç Live Order Tracking</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Map -->
                        <div>
                            <div id="map" class="mb-4"></div>
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-bold">Estimated Delivery Time</p>
                                    <p id="estimated-time" class="text-2xl font-bold text-green-600">25-30 mins</p>
                                </div>
                                <button id="call-rider" 
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                    üìû Call Rider
                                </button>
                            </div>
                        </div>
                        
                        <!-- Rider Info -->
                        <div>
                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
                                <div class="flex items-center gap-4 mb-4">
                                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                                        <span class="text-2xl">üöö</span>
                                    </div>
                                    <div>
                                        <h4 class="text-xl font-bold" id="rider-name">Rider Name</h4>
                                        <p class="text-gray-600" id="rider-status">On the way</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span>Phone:</span>
                                        <span class="font-bold" id="rider-phone">+91 00000 00000</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Vehicle:</span>
                                        <span class="font-bold" id="rider-vehicle">Motorcycle</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Distance:</span>
                                        <span class="font-bold" id="rider-distance">0.0 km</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ETA:</span>
                                        <span class="font-bold text-green-600" id="rider-eta">25 mins</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Order OTP -->
                            <div class="bg-purple-50 border border-purple-200 rounded-xl p-6">
                                <h4 class="text-lg font-bold mb-4">üîê Delivery OTP</h4>
                                <p class="text-3xl font-bold text-center text-purple-600 mb-4" id="delivery-otp">000000</p>
                                <p class="text-sm text-center text-gray-600">
                                    Share this OTP with the delivery partner to receive your order
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order Details -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-6">üì¶ Order Details</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Items List -->
                    <div>
                        <h3 class="text-lg font-bold mb-4">Order Items</h3>
                        <div id="order-items" class="space-y-3">
                            <!-- Items will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Customer & Payment Info -->
                    <div>
                        <h3 class="text-lg font-bold mb-4">üë§ Customer Information</h3>
                        <div class="space-y-4">
                            <div class="bg-gray-50 rounded-xl p-4">
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span>Name:</span>
                                        <span class="font-bold" id="customer-name">Loading...</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Phone:</span>
                                        <span class="font-bold" id="customer-phone">Loading...</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Delivery Type:</span>
                                        <span class="font-bold" id="delivery-type">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                                <h4 class="font-bold mb-3">üí∞ Payment Details</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span>Payment Method:</span>
                                        <span class="font-bold" id="payment-method">Loading...</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Payment ID:</span>
                                        <span class="font-medium text-sm" id="payment-id">Loading...</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Payment Status:</span>
                                        <span class="font-bold text-green-600">‚úÖ Paid</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                                <h4 class="font-bold mb-2">üìç Delivery Address</h4>
                                <p id="delivery-address" class="text-sm">Loading address...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Support Section -->
            <div class="mt-8 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl p-8">
                <div class="text-center">
                    <h3 class="text-2xl font-bold mb-4">Need Help?</h3>
                    <p class="mb-6">Contact our customer support for any questions about your order</p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <a href="tel:+917651837322" 
                           class="px-6 py-3 bg-white text-blue-600 font-bold rounded-xl hover:bg-gray-100 transition-colors">
                            üìû Call Support: +91 76518 37322
                        </a>
                        <a href="https://wa.me/917651837322" 
                           target="_blank"
                           class="px-6 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors">
                            üí¨ WhatsApp Support
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Order Lookup Modal -->
    <div id="lookup-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl border border-gray-100">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <span class="text-3xl">üì¶</span>
                </div>
                <h3 class="text-2xl font-bold mb-2">Track Your Order</h3>
                <p class="text-gray-600">Enter your Order ID to track your order status</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="text-sm font-bold text-gray-700 mb-2 block">Order ID</label>
                    <input type="text" id="track-order-id" 
                           placeholder="Enter your Order ID" 
                           class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none"
                           value="">
                </div>
                
                <div>
                    <label class="text-sm font-bold text-gray-700 mb-2 block">Phone Number</label>
                    <input type="tel" id="track-phone" 
                           placeholder="Enter registered phone number" 
                           class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none"
                           value="">
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <p class="text-sm text-blue-800">
                        üí° <strong>Tip:</strong> You can find your Order ID in your order confirmation email or WhatsApp message.
                    </p>
                </div>
            </div>
            
            <div class="flex gap-4 mt-8">
                <button onclick="trackOrder()" 
                        class="flex-1 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors shadow-lg">
                    üîç Track Order
                </button>
                <button onclick="closeLookupModal()" 
                        class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification Toast -->
    <div id="notification-toast" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl p-4 max-w-sm border-l-4 border-green-500">
            <div class="flex items-center gap-3">
                <span id="notification-icon" class="text-green-500 text-xl">‚úÖ</span>
                <div>
                    <p id="notification-title" class="font-bold">Success</p>
                    <p id="notification-message" class="text-sm text-gray-600">Operation completed successfully</p>
                </div>
            </div>
        </div>
    </div>

<!-- Firebase JavaScript -->
<script>
// ==================== FIREBASE CONFIGURATION ====================
const firebaseConfig = {
    apiKey: "AIzaSyCU_wJYBTwEwMZQ-iTYOjUZuEHEphA0DXc",
    authDomain: "easygo-10f4b.firebaseapp.com",
    databaseURL: "https://easygo-10f4b-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "easygo-10f4b",
    storageBucket: "easygo-10f4b.firebasestorage.app",
    messagingSenderId: "197660067542",
    appId: "1:197660067542:web:6c616efb479b122f1f6b77"
};

// ==================== GLOBAL VARIABLES ====================
let database;
let isFirebaseConnected = false;
let currentOrderId = null;
let currentOrderData = null;
let orderListener = null;
let map = null;
let restaurantMarker = null;
let customerMarker = null;
let riderMarker = null;
let deliveryRoute = null;
let riderLocationListener = null;

// Restaurant location
const RESTAURANT_LOCATION = {
    lat: 22.7767737,
    lng: 75.9605483,
    address: "Prime Square, Omaxe City 1, Indore"
};

// ==================== FIREBASE INITIALIZATION ====================
function initializeFirebase() {
    try {
        const app = firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        
        // Monitor connection status
        database.ref(".info/connected").on("value", function(snap) {
            const statusElement = document.getElementById('firebaseStatus');
            
            if (snap.val() === true) {
                isFirebaseConnected = true;
                statusElement.textContent = "‚úÖ Live Tracking Active";
                statusElement.className = "firebase-status bg-green-500 text-white";
                
                // Hide after 3 seconds
                setTimeout(() => {
                    statusElement.classList.add('hidden');
                }, 3000);
                
                console.log("Firebase connected - Real-time tracking active");
            } else {
                isFirebaseConnected = false;
                statusElement.textContent = "‚ùå Connection Lost";
                statusElement.className = "firebase-status bg-red-500 text-white";
                statusElement.classList.remove('hidden');
            }
        });
        
        // Show initial connecting status
        const statusElement = document.getElementById('firebaseStatus');
        statusElement.classList.remove('hidden');
        statusElement.textContent = "üîÑ Connecting to Firebase...";
        statusElement.className = "firebase-status bg-yellow-500 text-white";
        
        return true;
    } catch (error) {
        console.error("Firebase initialization error:", error);
        document.getElementById('firebaseStatus').classList.add('hidden');
        return false;
    }
}

// ==================== ORDER TRACKING FUNCTIONS ====================
function trackOrder() {
    const orderId = document.getElementById('track-order-id').value.trim();
    const phone = document.getElementById('track-phone').value.trim();
    
    if (!orderId) {
        showNotification('warning', 'Order ID Required', 'Please enter your Order ID');
        return;
    }
    
    if (!phone) {
        showNotification('warning', 'Phone Required', 'Please enter your phone number');
        return;
    }
    
    // Clear previous listener
    if (orderListener) {
        orderListener.off();
        orderListener = null;
    }
    
    if (riderLocationListener) {
        riderLocationListener.off();
        riderLocationListener = null;
    }
    
    currentOrderId = orderId;
    
    // Look for order in Firebase
    database.ref('orders').orderByChild('orderId').equalTo(orderId).once('value')
        .then(snapshot => {
            const orders = snapshot.val();
            if (!orders) {
                // Check in orderHistory
                database.ref('orderHistory').orderByChild('orderId').equalTo(orderId).once('value')
                    .then(historySnapshot => {
                        const historyOrders = historySnapshot.val();
                        if (historyOrders) {
                            const orderKey = Object.keys(historyOrders)[0];
                            const order = historyOrders[orderKey];
                            
                            // Verify phone number
                            if (order.customerPhone === phone || order.customerPhone.endsWith(phone)) {
                                showOrderDetails(order, orderKey);
                                closeLookupModal();
                            } else {
                                showNotification('error', 'Verification Failed', 'Phone number does not match order');
                            }
                        } else {
                            showNotification('error', 'Order Not Found', 'No order found with this ID');
                        }
                    });
                return;
            }
            
            const orderKey = Object.keys(orders)[0];
            const order = orders[orderKey];
            
            // Verify phone number
            if (order.customerPhone === phone || order.customerPhone.endsWith(phone)) {
                // Setup real-time listener for this order
                setupOrderListener(orderKey);
                showOrderDetails(order, orderKey);
                closeLookupModal();
            } else {
                showNotification('error', 'Verification Failed', 'Phone number does not match order');
            }
        })
        .catch(error => {
            console.error("Error fetching order:", error);
            showNotification('error', 'Tracking Failed', 'Unable to fetch order details');
        });
}

function setupOrderListener(orderKey) {
    if (!isFirebaseConnected) {
        console.warn("Firebase not connected, cannot setup listener");
        setTimeout(() => setupOrderListener(orderKey), 3000);
        return;
    }
    
    console.log("Setting up order listener for:", orderKey);
    
    orderListener = database.ref('orders/' + orderKey).on('value', function(snapshot) {
        const order = snapshot.val();
        if (order) {
            updateOrderDisplay(order, orderKey);
            
            // If order has rider, track rider location
            if (order.riderId) {
                trackRiderLocation(order.riderId, order);
            }
        } else {
            // Order might have moved to history
            database.ref('orderHistory/' + orderKey).once('value')
                .then(historySnapshot => {
                    const historyOrder = historySnapshot.val();
                    if (historyOrder) {
                        updateOrderDisplay(historyOrder, orderKey);
                        showNotification('info', 'Order Completed', 'This order has been delivered or cancelled');
                    } else {
                        showNotification('warning', 'Order Not Found', 'Order might have been removed');
                    }
                });
        }
    });
}

function updateOrderDisplay(order, orderKey) {
    currentOrderData = order;
    
    // Update basic order info
    document.getElementById('order-id').textContent = `Order #${order.orderId || orderKey.substring(0, 8)}`;
    document.getElementById('order-amount').textContent = `‚Çπ${order.totalAmount || 0}`;
    document.getElementById('order-time').textContent = `Ordered: ${new Date(order.createdAt || Date.now()).toLocaleString()}`;
    
    // Update status badge
    const status = order.status || 'pending';
    const statusText = getStatusText(status);
    const statusColor = getStatusColor(status);
    document.getElementById('order-status-badge').textContent = statusText;
    document.getElementById('order-status-badge').className = `inline-block px-3 py-1 rounded-full text-sm font-bold ${statusColor}`;
    
    // Update progress
    const progress = calculateOrderProgress(order);
    document.getElementById('progress-fill').style.width = `${progress}%`;
    document.getElementById('progress-text').textContent = `${progress}%`;
    
    // Update timeline
    updateTimeline(order);
    
    // Update delivery info
    updateDeliveryInfo(order);
    
    // Update order details
    updateOrderDetails(order);
    
    // Show/hide live tracking
    if (status === 'out-for-delivery' && order.deliveryMode === 'delivery') {
        document.getElementById('live-tracking-section').classList.remove('hidden');
        initMap(order);
        
        // Update call rider button
        if (order.deliveryPartnerPhone) {
            document.getElementById('call-rider').onclick = function() {
                window.open(`tel:${order.deliveryPartnerPhone}`, '_blank');
            };
        }
    } else {
        document.getElementById('live-tracking-section').classList.add('hidden');
    }
    
    // Update customer info
    document.getElementById('customer-name').textContent = order.customerName || 'Customer';
    document.getElementById('customer-phone').textContent = order.customerPhone || 'Not provided';
    document.getElementById('delivery-type').textContent = order.deliveryMode === 'delivery' ? 'üõµ Home Delivery' : 'üè™ Takeaway';
    document.getElementById('payment-method').textContent = order.paymentMethod || 'Razorpay';
    document.getElementById('payment-id').textContent = order.razorpayPaymentId || 'N/A';
    document.getElementById('delivery-address').textContent = order.address || 'Not provided';
    document.getElementById('delivery-otp').textContent = order.otp || '000000';
}

function calculateOrderProgress(order) {
    const status = order.status || 'pending';
    const progressMap = {
        'pending': 10,
        'confirmed': 25,
        'preparing': 40,
        'ready': 60,
        'out-for-delivery': 80,
        'delivered': 100,
        'cancelled': 0
    };
    return progressMap[status] || 0;
}

function getStatusText(status) {
    const statusMap = {
        'pending': '‚è≥ Pending',
        'confirmed': '‚úÖ Confirmed',
        'preparing': 'üë®‚Äçüç≥ Preparing',
        'ready': '‚úÖ Ready',
        'out-for-delivery': 'üõµ Out for Delivery',
        'delivered': '‚úÖ Delivered',
        'cancelled': '‚ùå Cancelled'
    };
    return statusMap[status] || 'Pending';
}

function getStatusColor(status) {
    const colorMap = {
        'pending': 'bg-yellow-100 text-yellow-800',
        'confirmed': 'bg-blue-100 text-blue-800',
        'preparing': 'bg-purple-100 text-purple-800',
        'ready': 'bg-green-100 text-green-800',
        'out-for-delivery': 'bg-orange-100 text-orange-800',
        'delivered': 'bg-green-100 text-green-800',
        'cancelled': 'bg-red-100 text-red-800'
    };
    return colorMap[status] || 'bg-gray-100 text-gray-800';
}

function updateTimeline(order) {
    const timeline = document.getElementById('order-timeline');
    const steps = [
        { id: 'ordered', icon: 'üì¶', title: 'Order Placed', time: order.createdAt, active: true },
        { id: 'confirmed', icon: '‚úÖ', title: 'Order Confirmed', time: order.confirmedAt, active: order.status !== 'pending' },
        { id: 'preparing', icon: 'üë®‚Äçüç≥', title: 'Food Preparing', time: order.preparingAt, active: ['preparing', 'ready', 'out-for-delivery', 'delivered'].includes(order.status) },
        { id: 'ready', icon: '‚úÖ', title: 'Order Ready', time: order.readyAt, active: ['ready', 'out-for-delivery', 'delivered'].includes(order.status) },
        { id: 'out-for-delivery', icon: 'üõµ', title: 'Out for Delivery', time: order.outForDeliveryAt, active: ['out-for-delivery', 'delivered'].includes(order.status) },
        { id: 'delivered', icon: 'üè†', title: 'Order Delivered', time: order.deliveredAt, active: order.status === 'delivered' }
    ];
    
    let timelineHTML = '';
    
    steps.forEach((step, index) => {
        let stepClass = 'pending';
        let timeText = '';
        
        if (step.active) {
            stepClass = 'completed';
            if (order.status === step.id) {
                stepClass = 'active';
            }
            
            if (step.time) {
                timeText = `<p class="text-sm text-gray-600">${new Date(step.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>`;
            }
        }
        
        timelineHTML += `
            <div class="timeline-step ${stepClass}">
                <div class="timeline-icon">${step.icon}</div>
                <div class="timeline-line"></div>
                <div>
                    <h4 class="font-bold">${step.title}</h4>
                    ${timeText}
                </div>
            </div>
        `;
    });
    
    timeline.innerHTML = timelineHTML;
}

function updateDeliveryInfo(order) {
    const deliveryInfo = document.getElementById('delivery-info');
    
    if (order.deliveryMode === 'delivery') {
        let deliveryHTML = '';
        
        if (order.deliveryPartner) {
            deliveryHTML += `
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-xl">üöö</span>
                        </div>
                        <div>
                            <h4 class="font-bold">${order.deliveryPartner}</h4>
                            <p class="text-sm text-gray-600">Delivery Partner</p>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Phone:</span>
                            <span class="font-bold">${order.deliveryPartnerPhone || 'Not provided'}</span>
                        </div>
                        ${order.deliveryAssignedAt ? `
                            <div class="flex justify-between">
                                <span>Assigned:</span>
                                <span class="font-medium">${new Date(order.deliveryAssignedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        deliveryHTML += `
            <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                <h4 class="font-bold mb-2">üìç Delivery Address</h4>
                <p class="text-sm">${order.address || 'Not provided'}</p>
            </div>
            
            <div class="bg-purple-50 border border-purple-200 rounded-xl p-4">
                <h4 class="font-bold mb-2">üîê Delivery OTP</h4>
                <p class="text-2xl font-bold text-center text-purple-600">${order.otp || '000000'}</p>
                <p class="text-sm text-center text-gray-600 mt-2">Share with delivery partner</p>
            </div>
        `;
        
        deliveryInfo.innerHTML = deliveryHTML;
    } else {
        deliveryInfo.innerHTML = `
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                <h4 class="font-bold mb-2">üè™ Pickup Information</h4>
                <p class="text-sm mb-3">Your order will be ready for pickup at:</p>
                <div class="bg-white rounded-lg p-3">
                    <p class="font-bold">EasyGo Restaurant</p>
                    <p class="text-sm text-gray-600">Prime Square, Omaxe City 1, Indore</p>
                    <p class="text-sm text-gray-600 mt-2">Timings: 6:00 PM - 10:00 PM</p>
                </div>
            </div>
            
            <div class="bg-purple-50 border border-purple-200 rounded-xl p-4">
                <h4 class="font-bold mb-2">üîê Pickup OTP</h4>
                <p class="text-2xl font-bold text-center text-purple-600">${order.otp || '000000'}</p>
                <p class="text-sm text-center text-gray-600 mt-2">Show at counter to collect order</p>
            </div>
        `;
    }
}

function updateOrderDetails(order) {
    const itemsContainer = document.getElementById('order-items');
    
    if (!order.items || order.items.length === 0) {
        itemsContainer.innerHTML = '<p class="text-gray-500">No items found</p>';
        return;
    }
    
    let itemsHTML = '';
    order.items.forEach(item => {
        const itemTotal = parseFloat(item.price || 0) * (parseInt(item.quantity) || 1);
        itemsHTML += `
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <div>
                    <p class="font-medium">${item.name}</p>
                    <p class="text-sm text-gray-600">${item.quantity} √ó ${item.size || item.pack || 'Regular'}</p>
                </div>
                <span class="font-bold">‚Çπ${itemTotal.toFixed(2)}</span>
            </div>
        `;
    });
    
    // Add total
    itemsHTML += `
        <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg font-bold">
            <span>Total Amount:</span>
            <span class="text-green-600">‚Çπ${order.totalAmount || 0}</span>
        </div>
    `;
    
    itemsContainer.innerHTML = itemsHTML;
}

function trackRiderLocation(riderId, order) {
    if (riderLocationListener) {
        riderLocationListener.off();
    }
    
    riderLocationListener = database.ref('riders/' + riderId).on('value', function(snapshot) {
        const rider = snapshot.val();
        if (rider && rider.location) {
            updateRiderInfo(rider, order);
            updateRiderMarker(rider.location);
        }
    });
}

function updateRiderInfo(rider, order) {
    document.getElementById('rider-name').textContent = rider.name || 'Delivery Partner';
    document.getElementById('rider-phone').textContent = rider.phone || '+91 00000 00000';
    document.getElementById('rider-status').textContent = rider.status === 'busy' ? 'On the way' : 'Available';
    document.getElementById('rider-vehicle').textContent = 'Motorcycle';
    
    // Update call rider button
    if (rider.phone) {
        document.getElementById('call-rider').onclick = function() {
            window.open(`tel:${rider.phone}`, '_blank');
        };
    }
    
    // Calculate distance and ETA
    if (rider.location && order.customerLocation) {
        const distance = calculateDistance(
            rider.location.lat,
            rider.location.lng,
            order.customerLocation.lat,
            order.customerLocation.lng
        );
        document.getElementById('rider-distance').textContent = `${distance.toFixed(1)} km`;
        
        // Simple ETA calculation (assuming 20 km/h average speed)
        const etaMinutes = Math.round((distance / 20) * 60);
        document.getElementById('rider-eta').textContent = `${etaMinutes} mins`;
        document.getElementById('estimated-time').textContent = `${etaMinutes} mins`;
    }
}

// ==================== MAP FUNCTIONS ====================
function initMap(order) {
    if (!map) {
        // Initialize map with restaurant location
        map = L.map('map').setView([RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    }
    
    // Clear existing markers and route
    if (restaurantMarker) map.removeLayer(restaurantMarker);
    if (customerMarker) map.removeLayer(customerMarker);
    if (deliveryRoute) map.removeLayer(deliveryRoute);
    if (riderMarker) map.removeLayer(riderMarker);
    
    // Restaurant marker
    restaurantMarker = L.marker([RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng]).addTo(map)
        .bindPopup('<b>EasyGo Restaurant</b><br>üìç Pickup Location')
        .openPopup();
    
    // Customer marker for delivery orders
    if (order.deliveryMode === 'delivery' && order.customerLocation) {
        const customerLocation = order.customerLocation;
        
        customerMarker = L.marker([customerLocation.lat, customerLocation.lng]).addTo(map)
            .bindPopup('<b>Delivery Location</b>')
            .openPopup();
        
        // Add route line
        deliveryRoute = L.polyline([
            [RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng],
            [customerLocation.lat, customerLocation.lng]
        ], {
            color: 'blue',
            weight: 3,
            opacity: 0.7,
            dashArray: '10, 10'
        }).addTo(map);
        
        // Fit bounds to show both markers
        map.fitBounds([
            [RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng],
            [customerLocation.lat, customerLocation.lng]
        ]);
    } else if (order.deliveryMode === 'delivery' && order.address) {
        // Try to geocode address (simplified - in production use proper geocoding)
        // For now, just show restaurant location
        map.setView([RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng], 13);
    }
}

function updateRiderMarker(location) {
    if (!map) return;
    
    if (riderMarker) {
        riderMarker.setLatLng([location.lat, location.lng]);
    } else {
        riderMarker = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                className: 'rider-marker',
                html: '<div style="background-color: #3b82f6; color: white; padding: 5px 10px; border-radius: 50%; font-weight: bold;">üöö</div>',
                iconSize: [30, 30]
            })
        }).addTo(map)
        .bindPopup('<b>Delivery Partner</b><br>üõµ On the way');
    }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth's radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// ==================== UTILITY FUNCTIONS ====================
function showOrderDetails(order, orderKey) {
    // Update URL with order ID for sharing
    const url = new URL(window.location);
    url.searchParams.set('orderId', order.orderId || orderKey);
    url.searchParams.set('phone', order.customerPhone);
    window.history.pushState({}, '', url);
    
    updateOrderDisplay(order, orderKey);
}

function closeLookupModal() {
    document.getElementById('lookup-modal').classList.add('hidden');
}

function showLookupModal() {
    document.getElementById('lookup-modal').classList.remove('hidden');
}

function updateCurrentTime() {
    const now = new Date();
    document.getElementById('current-time').textContent = 
        now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function showNotification(type, title, message) {
    const toast = document.getElementById('notification-toast');
    const icon = document.getElementById('notification-icon');
    const titleElement = document.getElementById('notification-title');
    const messageElement = document.getElementById('notification-message');
    
    // Set colors based on type
    let borderColor = 'border-green-500';
    let iconText = '‚úÖ';
    
    switch(type) {
        case 'success':
            borderColor = 'border-green-500';
            iconText = '‚úÖ';
            break;
        case 'error':
            borderColor = 'border-red-500';
            iconText = '‚ùå';
            break;
        case 'warning':
            borderColor = 'border-yellow-500';
            iconText = '‚ö†Ô∏è';
            break;
        case 'info':
            borderColor = 'border-blue-500';
            iconText = '‚ÑπÔ∏è';
            break;
    }
    
    // Update content
    icon.textContent = iconText;
    titleElement.textContent = title;
    messageElement.textContent = message;
    toast.className = `fixed top-4 right-4 z-50 bg-white rounded-xl shadow-xl p-4 max-w-sm border-l-4 ${borderColor}`;
    
    // Show toast
    toast.classList.remove('hidden');
    
    // Hide after 3 seconds
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}

// ==================== URL PARAMETER HANDLING ====================
function checkUrlParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('orderId');
    const phone = urlParams.get('phone');
    
    if (orderId && phone) {
        document.getElementById('track-order-id').value = orderId;
        document.getElementById('track-phone').value = phone;
        trackOrder();
    } else {
        // Show lookup modal on page load
        showLookupModal();
    }
}

// ==================== INITIALIZATION ====================
window.addEventListener('DOMContentLoaded', () => {
    // Initialize Firebase
    initializeFirebase();
    
    // Update time
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    
    // Check URL parameters
    checkUrlParameters();
    
    // Handle Enter key in lookup form
    document.getElementById('track-order-id').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            trackOrder();
        }
    });
    
    document.getElementById('track-phone').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            trackOrder();
        }
    });
    
    // Handle browser back/forward
    window.addEventListener('popstate', function() {
        checkUrlParameters();
    });
});
</script>
</body>
</html>
