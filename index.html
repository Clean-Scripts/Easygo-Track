<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Leaflet for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <title>Easy Go | Track Order</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Tracking Steps */
        .tracking-step { 
            transition: all 0.3s; 
            position: relative;
        }
        
        .tracking-step::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #e5e7eb;
            z-index: -1;
        }
        
        .tracking-step:last-child::after {
            display: none;
        }
        
        .tracking-step.active { 
            background-color: #10b981; 
            color: white; 
        }
        
        .tracking-step.completed { 
            background-color: #059669; 
            color: white; 
        }
        
        .tracking-step.active .step-icon,
        .tracking-step.completed .step-icon {
            background: white !important;
            color: #10b981 !important;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Firebase Status Indicator */
        .firebase-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        /* Real-time indicator */
        .real-time-indicator {
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #map { 
            height: 400px; 
            border-radius: 1rem;
        }
        
        .live-rider-tracker {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 1rem;
            margin-top: 20px;
        }
        
        .waiting-charge-indicator {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 10px;
            border-radius: 0.5rem;
            margin-top: 10px;
        }
        
        .rider-pulse {
            animation: riderPulse 1s infinite;
        }
        
        @keyframes riderPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="antialiased bg-gray-50">

    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" class="firebase-status hidden">
        üîÑ Connecting...
    </div>

    <!-- Empty Order Overlay -->
    <div id="emptyOrderOverlay" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md mx-4">
            <div class="text-6xl mb-6">üì¶</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">No Active Order Found</h2>
            <p class="text-gray-600 mb-6">You don't have any active orders to track.</p>
            <p class="text-sm text-gray-500 mb-8">Redirecting to menu in <span id="redirect-countdown">5</span> seconds...</p>
            <a href="https://clean-scripts.github.io/Easygo-Menu/" 
               class="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold rounded-xl hover:opacity-90 transition">
                üõí Go to Menu Now
            </a>
        </div>
    </div>

    <header class="relative mb-8">
        <div class="h-40 overflow-hidden">
            <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/Banner.png" 
                 class="w-full h-full object-cover" alt="Easy Go Banner">
        </div>
        <div class="absolute -bottom-6 left-0 right-0 flex justify-center">
            <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                 class="h-20 w-20 rounded-full border-4 border-white shadow-xl bg-white p-1">
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 pt-10 pb-20">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-black uppercase mb-4">Track Your Order</h1>
            <p class="text-gray-600 flex items-center justify-center gap-2">
                <span class="real-time-indicator">‚óè</span> Real-time updates
            </p>
        </div>
        
        <!-- Order Status Badge -->
        <div class="mb-8 text-center">
            <div id="order-status-badge" class="inline-flex items-center gap-2 px-6 py-3 bg-yellow-100 text-yellow-800 rounded-full">
                <span class="text-xl">‚è≥</span>
                <span class="font-bold">Order Received - Pending</span>
            </div>
            <p class="text-sm text-gray-500 mt-2">Order ID: <span id="order-id-display" class="font-bold">--</span></p>
            <div id="countdown-timer" class="mt-2 text-sm font-bold text-blue-600 hidden">
                ‚è∞ Restaurant will respond in: <span id="countdown-time">02:00</span>
            </div>
        </div>
        
        <!-- Tracking Steps -->
        <div class="flex flex-col md:flex-row justify-between mb-12 relative">
            <div id="step-1" class="tracking-step flex flex-col items-center p-6 rounded-2xl mb-4 md:mb-0">
                <div class="step-icon w-16 h-16 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-2xl mb-4">
                    üì¶
                </div>
                <p class="font-bold">Order Placed</p>
                <p class="text-sm">Order confirmed</p>
            </div>
            
            <div id="step-2" class="tracking-step flex flex-col items-center p-6 rounded-2xl mb-4 md:mb-0">
                <div class="step-icon w-16 h-16 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-2xl mb-4">
                    üë®‚Äçüç≥
                </div>
                <p class="font-bold">Preparing</p>
                <p class="text-sm">Food being prepared</p>
            </div>
            
            <div id="step-delivery" class="tracking-step flex flex-col items-center p-6 rounded-2xl mb-4 md:mb-0 hidden">
                <div class="step-icon w-16 h-16 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-2xl mb-4">
                    üõµ
                </div>
                <p class="font-bold">On the Way</p>
                <p class="text-sm">Out for delivery</p>
            </div>
            
            <div id="step-pickup" class="tracking-step flex flex-col items-center p-6 rounded-2xl mb-4 md:mb-0">
                <div class="step-icon w-16 h-16 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-2xl mb-4">
                    üè™
                </div>
                <p class="font-bold">Ready for Pickup</p>
                <p class="text-sm">Order is ready</p>
            </div>
            
            <div id="step-5" class="tracking-step flex flex-col items-center p-6 rounded-2xl">
                <div class="step-icon w-16 h-16 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-2xl mb-4">
                    ‚úÖ
                </div>
                <p class="font-bold">Completed</p>
                <p class="text-sm">Order completed</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <!-- Order Details -->
            <div>
                <div class="bg-white rounded-3xl shadow-lg p-8 mb-8">
                    <h2 class="text-2xl font-bold mb-6">üìã Order Details</h2>
                    
                    <div id="order-summary" class="space-y-4 mb-6">
                        <!-- Order summary loaded from Firebase -->
                    </div>
                    
                    <!-- OTP Section -->
                    <div class="bg-green-50 border border-green-200 rounded-2xl p-6">
                        <h3 class="font-bold text-green-800 mb-4">üîê Delivery Verification OTP</h3>
                        <div class="text-center">
                            <p class="text-5xl font-bold text-green-600 mb-4" id="otp-display">XXXXXX</p>
                            <p class="text-green-700 mb-4">
                                Share this OTP with the delivery partner when your order arrives
                            </p>
                            <button id="share-otp" 
                                    class="px-6 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors">
                                üì§ Share OTP with EasyGo
                            </button>
                            <p class="text-xs text-green-600 mt-3">
                                ‚úÖ This OTP verifies that you received the order
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Customer Details -->
                <div class="bg-white rounded-3xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6">üë§ Your Details</h2>
                    <div id="customer-details" class="space-y-4">
                        <!-- Customer details loaded from Firebase -->
                    </div>
                </div>
            </div>
            
            <!-- Map Container & Status Updates -->
            <div>
                <div class="bg-white rounded-3xl shadow-lg p-8 mb-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center justify-between">
                        <span>üìç Live Tracking Map</span>
                        <span id="rider-status" class="text-sm font-normal text-gray-500"></span>
                    </h2>
                    <div id="map" class="mb-4">
                        <!-- Leaflet map will be rendered here -->
                    </div>
                    
                    <!-- Live Rider Tracker -->
                    <div id="live-rider-tracker" class="live-rider-tracker hidden">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center rider-pulse">
                                    <span class="text-xl">üõµ</span>
                                </div>
                                <div>
                                    <p class="font-bold text-lg" id="rider-name">Rider Name</p>
                                    <p class="text-sm opacity-90" id="rider-distance">Distance: -- km</p>
                                </div>
                            </div>
                            <div id="waiting-charge-indicator" class="waiting-charge-indicator hidden">
                                <p class="text-sm font-bold text-yellow-800">
                                    ‚è∞ Waiting Charge: <span id="waiting-charge-amount">‚Çπ0</span>
                                </p>
                            </div>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-3 gap-2 text-center">
                            <div class="bg-white/20 p-2 rounded">
                                <p class="text-xs">Speed</p>
                                <p class="font-bold" id="rider-speed">25 km/h</p>
                            </div>
                            <div class="bg-white/20 p-2 rounded">
                                <p class="text-xs">ETA</p>
                                <p class="font-bold" id="eta-dynamic">25 min</p>
                            </div>
                            <div class="bg-white/20 p-2 rounded">
                                <p class="text-xs">Last Updated</p>
                                <p class="font-bold" id="last-updated">Just now</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rider Contact Section -->
                    <div class="mt-6 p-4 bg-blue-50 rounded-xl">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-blue-800">Estimated Arrival</p>
                                <p id="eta" class="text-3xl font-black text-blue-600">25-30 min</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-blue-600">Delivery Partner</p>
                                <p class="font-bold" id="delivery-partner-name">--</p>
                                <div class="mt-4">
                                    <a id="call-rider-btn" href="#" 
                                       class="inline-flex items-center gap-3 px-8 py-4 bg-white border-2 border-gray-100 rounded-[2rem] shadow-lg hover:shadow-indigo-100 hover:border-indigo-600 hover:scale-105 transition-all duration-300 group">
                                        <div class="bg-indigo-600 p-2 rounded-full shadow-md group-hover:rotate-12 transition-transform">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                            </svg>
                                        </div>
                                        <div class="flex flex-col items-start">
                                            <span class="text-[9px] font-black uppercase text-gray-400 tracking-widest leading-none">Tap to Call Rider</span>
                                            <span id="rider-phone-display" class="text-xl font-black text-gray-900 tracking-tighter">--</span>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Order Status Updates -->
                <div class="bg-white rounded-3xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6">üîÑ Status Updates</h2>
                    <div id="status-updates" class="space-y-4">
                        <!-- Real-time updates from Firebase -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- After Delivery Section -->
        <div id="after-delivery" class="hidden">
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-3xl shadow-lg p-12 text-center text-white">
                <div class="text-6xl mb-6">üéâ</div>
                <h2 class="text-3xl font-bold mb-4">Order Delivered Successfully!</h2>
                <p class="text-xl mb-8">Hope you enjoyed your meal. Please share your feedback with us.</p>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="https://www.google.com/maps/place/EasyGo/@22.7767506,75.9581962,17z/data=!3m1!4b1!4m6!3m5!1s0x39631d1e6d09fbb7:0x417f2409ea954602!8m2!3d22.7767506!4d75.9607711!16s%2Fg%2F11yt0fxskh?authuser=1&entry=ttu&g_ep=EgoyMDI5MTIwOS.0IKXMDSoKLDEwMDc5MjA3M0gBUAM%3D" 
                       target="_blank"
                       class="px-8 py-4 bg-white text-green-600 font-bold rounded-2xl hover:bg-gray-100 transition-colors">
                        ‚≠ê Rate us on Google
                    </a>
                    
                    <a href="https://clean-scripts.github.io/Easygo-Menu/" 
                       class="px-8 py-4 bg-transparent border-2 border-white text-white font-bold rounded-2xl hover:bg-white/10 transition-colors">
                        üõí Order Again
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Order Cancelled Section -->
        <div id="order-cancelled" class="hidden">
            <div class="bg-gradient-to-r from-red-500 to-pink-600 rounded-3xl shadow-lg p-12 text-center text-white">
                <div class="text-6xl mb-6">üò¢</div>
                <h2 class="text-3xl font-bold mb-4">Order Not Accepted</h2>
                <p class="text-xl mb-6">We're sorry, but we couldn't accept your order at this time.</p>
                
                <div class="bg-white/20 rounded-2xl p-6 max-w-md mx-auto mb-8">
                    <p class="font-bold mb-2">üí∏ Refund Information:</p>
                    <p>Your payment will be refunded within 5 working days.</p>
                    <p class="text-sm mt-2">Amount will appear in your account automatically.</p>
                    <p class="text-sm mt-2">Refund ID: <span id="refund-id">--</span></p>
                </div>
                
                <a href="https://clean-scripts.github.io/Easygo-Menu/" 
                   class="px-8 py-4 bg-white text-red-600 font-bold rounded-2xl hover:bg-gray-100 transition-colors">
                    üõçÔ∏è Try Ordering Again
                </a>
            </div>
        </div>
        
        <!-- Multiple Rider Notifications Section -->
        <div id="rider-notifications-info" class="hidden mt-8 bg-blue-50 border border-blue-200 rounded-2xl p-6">
            <h3 class="text-xl font-bold text-blue-800 mb-4">üöö Rider Assignment Process</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-xl">
                    <p class="font-bold mb-2">üîî Notification Flow:</p>
                    <ul class="text-sm space-y-1">
                        <li>‚úì Nearest rider notified first (15 seconds)</li>
                        <li>‚úì If declined, next nearest rider gets notification</li>
                        <li>‚úì Radius expands until rider accepts</li>
                        <li>‚úì Multiple orders can be assigned to same rider</li>
                    </ul>
                </div>
                <div class="bg-white p-4 rounded-xl">
                    <p class="font-bold mb-2">üí∞ Rider Earnings:</p>
                    <ul class="text-sm space-y-1">
                        <li>‚úì 5% of order value + 18% GST on platform fee</li>
                        <li>‚úì +‚Çπ1 per 30 sec wait at restaurant (after 2 min)</li>
                        <li>‚úì +‚Çπ2 per 60 sec wait at your location (after 100 sec)</li>
                        <li>‚úì Earnings update in real-time</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                             class="h-12 w-12 rounded-full bg-white p-1 mr-3">
                        <div>
                            <h2 class="text-xl font-bold">Easy Go</h2>
                            <p class="text-gray-400 text-sm">Delivering Freshness & Speed !</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-gray-400 text-sm mb-2">
                        ¬© 2024 Easy Go | All Rights Reserved
                    </p>
                    <div class="mt-4">
                        <a href="https://clean-scripts.github.io/Easygo-Menu/" class="text-gray-400 hover:text-white text-sm mr-4">View Menu</a>
                        <a href="https://clean-scripts.github.io/Easygo-Privacy/" class="text-gray-400 hover:text-white text-sm mr-4">Privacy Policy</a>
                        <a href="https://clean-scripts.github.io/Easygo-Terms/" class="text-gray-400 hover:text-white text-sm">Terms & Conditions</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Firebase JavaScript -->
    <script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
        apiKey: "AIzaSyCU_wJYBTwEwMZQ-iTYOjUZuEHEphA0DXc",
        authDomain: "easygo-10f4b.firebaseapp.com",
        projectId: "easygo-10f4b",
        storageBucket: "easygo-10f4b.firebasestorage.app",
        messagingSenderId: "197660067542",
        appId: "1:197660067542:web:6c616efb479b122f1f6b77",
        databaseURL: "https://easygo-10f4b-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    // ==================== GLOBAL VARIABLES ====================
    let database;
    let isFirebaseConnected = false;
    let orderListener = null;
    let currentOrderId = null;
    let map = null;
    let riderMarker = null;
    let restaurantMarker = null;
    let customerMarker = null;
    let routeLine = null;
    let countdownTimer = null;
    let waitingChargeInterval = null;
    let riderLocationInterval = null;
    let currentOrderData = null;
    let acceptedTimer = null;

    // Location constants
    const RESTAURANT_LOCATION = {
        lat: 22.7767737,
        lng: 75.9605483,
        address: "Prime Square, Omaxe City 1, Indore"
    };

    // ==================== FIREBASE INITIALIZATION ====================
    function initializeFirebase() {
        try {
            const app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            
            // Monitor connection status
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", function(snap) {
                const statusElement = document.getElementById('firebaseStatus');
                
                if (snap.val() === true) {
                    isFirebaseConnected = true;
                    statusElement.textContent = "‚úÖ Connected to Database";
                    statusElement.className = "firebase-status bg-green-500 text-white";
                    console.log("Firebase connected - Real-time updates active");
                    
                    // Hide status after 3 seconds
                    setTimeout(() => {
                        statusElement.classList.add('hidden');
                    }, 3000);
                } else {
                    isFirebaseConnected = false;
                    statusElement.textContent = "‚ùå Database Disconnected";
                    statusElement.className = "firebase-status bg-red-500 text-white";
                    statusElement.classList.remove('hidden');
                }
            });
            
            // Show initial connecting status
            const statusElement = document.getElementById('firebaseStatus');
            statusElement.classList.remove('hidden');
            statusElement.textContent = "üîÑ Connecting to Database...";
            statusElement.className = "firebase-status bg-yellow-500 text-white";
            
            // Initialize map
            initMap();
            
        } catch (error) {
            console.error("Firebase initialization error:", error);
            document.getElementById('firebaseStatus').classList.add('hidden');
        }
    }

    // ==================== MAP INITIALIZATION ====================
    function initMap() {
        // Initialize map with restaurant location
        map = L.map('map').setView([RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng], 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Add restaurant marker
        restaurantMarker = L.marker([RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng])
            .addTo(map)
            .bindPopup('<b>EasyGo Restaurant</b><br>üìç Pickup Location')
            .openPopup();
    }

    // ==================== ORDER DATA FUNCTIONS ====================
    function getOrderIdFromLocalStorage() {
        // First check localStorage for order ID
        const orderId = localStorage.getItem('easygo-order-id');
        
        // If no order ID, try to get from URL parameters
        if (!orderId) {
            const urlParams = new URLSearchParams(window.location.search);
            const orderParam = urlParams.get('order');
            return orderParam || null;
        }
        
        return orderId;
    }

    // ==================== REAL-TIME ORDER LISTENER ====================
    function setupOrderListener(orderId) {
        if (!orderId || !isFirebaseConnected) {
            console.error("Cannot setup listener: No order ID or Firebase disconnected");
            return false;
        }
        
        currentOrderId = orderId;
        
        // Remove existing listener if any
        if (orderListener) {
            orderListener.off();
        }
        
        // Setup real-time listener
        orderListener = database.ref(`orders/${orderId}`).on('value', (snapshot) => {
            const orderData = snapshot.val();
            
            if (orderData) {
                currentOrderData = orderData;
                
                // Update UI with real-time data
                updateOrderUI(orderData);
                
                // Save to localStorage for backup
                localStorage.setItem('easygo-last-order', JSON.stringify(orderData));
                
                // Start/stop timers based on status
                handleStatusTimers(orderData.status);
                
                // Update map based on order status
                updateMap(orderData);
                
                console.log("Real-time update received:", orderData.status);
            } else {
                // Order not found in Firebase
                showEmptyOrderOverlay();
            }
        }, (error) => {
            console.error("Firebase listener error:", error);
        });
        
        return true;
    }

    // ==================== STATUS TIMERS HANDLING ====================
    function handleStatusTimers(status) {
        // Clear existing timers
        if (countdownTimer) clearInterval(countdownTimer);
        if (waitingChargeInterval) clearInterval(waitingChargeInterval);
        if (riderLocationInterval) clearInterval(riderLocationInterval);
        if (acceptedTimer) clearInterval(acceptedTimer);
        
        switch(status) {
            case 'pending':
                // Show 2-minute countdown for restaurant acceptance
                startCountdownTimer(120, 'countdown-time');
                document.getElementById('countdown-timer').classList.remove('hidden');
                break;
                
            case 'confirmed':
                // Start auto-cancel timer (2 minutes for restaurant to accept)
                startAutoCancelTimer(120);
                break;
                
            case 'out-for-delivery':
                // Start rider location updates
                startRiderLocationUpdates();
                // Show rider notifications info
                document.getElementById('rider-notifications-info').classList.remove('hidden');
                break;
        }
    }

    function startCountdownTimer(seconds, elementId) {
        let timeLeft = seconds;
        const element = document.getElementById(elementId);
        
        countdownTimer = setInterval(() => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            element.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(countdownTimer);
            }
            timeLeft--;
        }, 1000);
    }

    function startAutoCancelTimer(minutes) {
        const autoCancelTime = minutes * 60 * 1000; // Convert to milliseconds
        acceptedTimer = setTimeout(() => {
            // Check if order is still in confirmed state
            database.ref(`orders/${currentOrderId}`).once('value').then(snapshot => {
                const order = snapshot.val();
                if (order && order.status === 'confirmed') {
                    // Auto-cancel the order
                    autoCancelOrder();
                }
            });
        }, autoCancelTime);
    }

    function autoCancelOrder() {
        const cancelUpdates = {
            status: 'cancelled',
            cancelledAt: Date.now(),
            cancelReason: 'Auto-cancelled: Restaurant did not accept within ' + 
                         (currentOrderData.deliveryMode === 'delivery' ? '2 minutes' : 'time limit'),
            updatedAt: Date.now()
        };
        
        database.ref('orders/' + currentOrderId).update(cancelUpdates)
            .then(() => {
                // Initiate refund
                initiateRefund(currentOrderData, 'Auto-cancelled by system');
            })
            .catch(error => {
                console.error("Error auto-cancelling order:", error);
            });
    }

    function startRiderLocationUpdates() {
        if (!currentOrderData.riderId) return;
        
        // Clear any existing interval
        if (riderLocationInterval) clearInterval(riderLocationInterval);
        
        // Set up interval to update rider location every 5 seconds
        riderLocationInterval = setInterval(() => {
            updateRiderLocationFromFirebase();
        }, 5000);
        
        // Do initial update
        updateRiderLocationFromFirebase();
    }

    // ==================== RIDER LOCATION TRACKING ====================
    function updateRiderLocationFromFirebase() {
        if (!currentOrderData || !currentOrderData.riderId) return;
        
        database.ref('riders/' + currentOrderData.riderId + '/location').once('value')
            .then(snapshot => {
                const location = snapshot.val();
                if (location && location.lat && location.lng) {
                    updateRiderMarker(location.lat, location.lng);
                    calculateAndUpdateETA(location);
                    
                    // Check for waiting charges
                    checkWaitingCharges(location);
                }
            })
            .catch(error => {
                console.error("Error fetching rider location:", error);
            });
    }

    function updateRiderMarker(lat, lng) {
        // Remove existing rider marker
        if (riderMarker) {
            map.removeLayer(riderMarker);
        }
        
        // Add new rider marker
        riderMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'rider-marker',
                html: '<div class="rider-pulse" style="background-color: #3b82f6; color: white; padding: 8px; border-radius: 50%; font-weight: bold;">üõµ</div>',
                iconSize: [30, 30]
            })
        }).addTo(map)
        .bindPopup('<b>Your Rider</b><br>On the way to deliver your order!');
        
        // Update distance display
        if (currentOrderData.deliveryMode === 'delivery' && currentOrderData.customerLocation) {
            const distance = calculateDistance(lat, lng, 
                currentOrderData.customerLocation.lat, 
                currentOrderData.customerLocation.lng);
            
            document.getElementById('rider-distance').textContent = 
                `Distance: ${distance.toFixed(2)} km`;
            
            // Estimate ETA based on distance (assuming 25km/h average speed)
            const etaMinutes = Math.round((distance / 25) * 60);
            document.getElementById('eta-dynamic').textContent = 
                `${etaMinutes} min`;
                
            // Update last updated time
            document.getElementById('last-updated').textContent = 'Just now';
        }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function calculateAndUpdateETA(location) {
        if (!currentOrderData || !currentOrderData.customerLocation) return;
        
        const distance = calculateDistance(location.lat, location.lng,
            currentOrderData.customerLocation.lat,
            currentOrderData.customerLocation.lng);
        
        // Simple ETA calculation: distance / average speed (25 km/h)
        const etaMinutes = Math.round((distance / 25) * 60);
        
        // Update ETA display
        const etaElement = document.getElementById('eta');
        if (etaMinutes < 5) {
            etaElement.textContent = "Arriving now";
            etaElement.className = "text-3xl font-black text-green-600";
        } else if (etaMinutes < 15) {
            etaElement.textContent = `${etaMinutes} min`;
            etaElement.className = "text-3xl font-black text-orange-600";
        } else {
            etaElement.textContent = `${etaMinutes} min`;
            etaElement.className = "text-3xl font-black text-blue-600";
        }
    }

    function checkWaitingCharges(location) {
        if (!currentOrderData) return;
        
        // Check if rider is near restaurant (within 5 meters)
        const restaurantDistance = calculateDistance(location.lat, location.lng,
            RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng);
        
        if (restaurantDistance < 0.005 && currentOrderData.riderArrivedAt) {
            // Rider is at restaurant, check waiting time
            const waitingTime = Date.now() - currentOrderData.riderArrivedAt;
            if (waitingTime > 120000) { // 2 minutes
                startRestaurantWaitingCharges();
            }
        }
        
        // Check if rider is near customer (for delivery orders)
        if (currentOrderData.deliveryMode === 'delivery' && 
            currentOrderData.customerLocation &&
            currentOrderData.riderArrivedCustomerAt) {
            
            const customerDistance = calculateDistance(location.lat, location.lng,
                currentOrderData.customerLocation.lat,
                currentOrderData.customerLocation.lng);
            
            if (customerDistance < 0.005) {
                // Rider is at customer location, check waiting time
                const customerWaitingTime = Date.now() - currentOrderData.riderArrivedCustomerAt;
                if (customerWaitingTime > 100000) { // 100 seconds
                    startCustomerWaitingCharges();
                }
            }
        }
    }

    function startRestaurantWaitingCharges() {
        if (waitingChargeInterval) clearInterval(waitingChargeInterval);
        
        document.getElementById('waiting-charge-indicator').classList.remove('hidden');
        
        // Add ‚Çπ1 every 30 seconds
        waitingChargeInterval = setInterval(() => {
            if (currentOrderData && !currentOrderData.pickedUpAt) {
                // Update waiting charge in Firebase
                const currentBonus = currentOrderData.waitingBonus || 0;
                database.ref('orders/' + currentOrderId).update({
                    waitingBonus: currentBonus + 1
                });
                
                // Update display
                document.getElementById('waiting-charge-amount').textContent = 
                    `‚Çπ${currentBonus + 1}`;
            } else {
                clearInterval(waitingChargeInterval);
                document.getElementById('waiting-charge-indicator').classList.add('hidden');
            }
        }, 30000); // 30 seconds
    }

    function startCustomerWaitingCharges() {
        if (waitingChargeInterval) clearInterval(waitingChargeInterval);
        
        document.getElementById('waiting-charge-indicator').classList.remove('hidden');
        
        // Add ‚Çπ2 every 60 seconds
        waitingChargeInterval = setInterval(() => {
            if (currentOrderData && !currentOrderData.deliveredAt) {
                // Update waiting charge in Firebase
                const currentBonus = currentOrderData.waitingBonus || 0;
                database.ref('orders/' + currentOrderId).update({
                    waitingBonus: currentBonus + 2
                });
                
                // Update display
                document.getElementById('waiting-charge-amount').textContent = 
                    `‚Çπ${currentBonus + 2}`;
            } else {
                clearInterval(waitingChargeInterval);
                document.getElementById('waiting-charge-indicator').classList.add('hidden');
            }
        }, 60000); // 60 seconds
    }

    // ==================== MAP UPDATES ====================
    function updateMap(orderData) {
        if (!map) return;
        
        // Clear existing markers except restaurant
        if (riderMarker) map.removeLayer(riderMarker);
        if (customerMarker) map.removeLayer(customerMarker);
        if (routeLine) map.removeLayer(routeLine);
        
        // Add customer marker for delivery orders
        if (orderData.deliveryMode === 'delivery' && orderData.customerLocation) {
            customerMarker = L.marker([
                orderData.customerLocation.lat,
                orderData.customerLocation.lng
            ]).addTo(map)
            .bindPopup('<b>Your Location</b><br>üìç Delivery Address');
            
            // Add route from restaurant to customer
            routeLine = L.polyline([
                [RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng],
                [orderData.customerLocation.lat, orderData.customerLocation.lng]
            ], {
                color: 'blue',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);
            
            // Fit bounds to show both locations
            const bounds = [
                [RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng],
                [orderData.customerLocation.lat, orderData.customerLocation.lng]
            ];
            map.fitBounds(bounds);
        }
        
        // Show live rider tracker for delivery orders
        if (orderData.status === 'out-for-delivery' && orderData.riderId) {
            document.getElementById('live-rider-tracker').classList.remove('hidden');
        }
    }

    // ==================== UI UPDATE FUNCTIONS ====================
    function updateOrderUI(orderData) {
        // Display order ID
        document.getElementById('order-id-display').textContent = orderData.orderId || currentOrderId;
        
        // Update OTP
        if (orderData.otp) {
            document.getElementById('otp-display').textContent = orderData.otp;
        }
        
        // Update order summary
        updateOrderSummary(orderData);
        
        // Update customer details
        updateCustomerDetails(orderData);
        
        // Update delivery partner info
        if (orderData.deliveryPartner) {
            document.getElementById('delivery-partner-name').textContent = orderData.deliveryPartner;
            document.getElementById('rider-name').textContent = orderData.deliveryPartner;
            
            if (orderData.deliveryPartnerPhone) {
                document.getElementById('rider-phone-display').textContent = orderData.deliveryPartnerPhone;
                document.getElementById('call-rider-btn').href = `tel:${orderData.deliveryPartnerPhone}`;
            }
            
            document.getElementById('rider-status').textContent = `Assigned to: ${orderData.deliveryPartner}`;
        }
        
        // Update status and tracking steps
        updateOrderStatus(orderData.status);
        
        // Add status update to timeline
        addStatusUpdate(orderData);
        
        // Handle completed/cancelled orders
        if (orderData.status === 'delivered') {
            showDeliveredMessage();
        } else if (orderData.status === 'cancelled') {
            showCancelledMessage(orderData);
        }
        
        // Update waiting charge display
        if (orderData.waitingBonus) {
            document.getElementById('waiting-charge-amount').textContent = `‚Çπ${orderData.waitingBonus}`;
        }
    }

    function updateOrderStatus(status) {
        const statusMap = {
            'pending': { 
                step: 1, 
                badge: 'Order Received - Pending', 
                badgeColor: 'bg-yellow-100 text-yellow-800', 
                badgeIcon: '‚è≥',
                eta: 'Processing'
            },
            'confirmed': { 
                step: 1, 
                badge: 'Order Confirmed', 
                badgeColor: 'bg-green-100 text-green-800', 
                badgeIcon: '‚úÖ',
                eta: '25-30 min'
            },
            'preparing': { 
                step: 2, 
                badge: 'Preparing Your Order', 
                badgeColor: 'bg-blue-100 text-blue-800', 
                badgeIcon: 'üë®‚Äçüç≥',
                eta: '20-25 min'
            },
            'ready': { 
                step: 3, 
                badge: 'Ready for Pickup', 
                badgeColor: 'bg-orange-100 text-orange-800', 
                badgeIcon: 'üè™',
                eta: 'Ready Now'
            },
            'out-for-delivery': { 
                step: 3, 
                badge: 'Out for Delivery', 
                badgeColor: 'bg-purple-100 text-purple-800', 
                badgeIcon: 'üõµ',
                eta: '15-20 min'
            },
            'delivered': { 
                step: 5, 
                badge: 'Order Delivered', 
                badgeColor: 'bg-green-100 text-green-800', 
                badgeIcon: '‚úÖ',
                eta: 'Arrived'
            },
            'cancelled': { 
                step: 0, 
                badge: 'Order Cancelled', 
                badgeColor: 'bg-red-100 text-red-800', 
                badgeIcon: '‚ùå',
                eta: 'N/A'
            }
        };
        
        const statusInfo = statusMap[status] || statusMap['pending'];
        
        // Update badge
        const badge = document.getElementById('order-status-badge');
        badge.className = `inline-flex items-center gap-2 px-6 py-3 ${statusInfo.badgeColor} rounded-full`;
        badge.innerHTML = `<span class="text-xl">${statusInfo.badgeIcon}</span><span class="font-bold">${statusInfo.badge}</span>`;
        
        // Update ETA
        document.getElementById('eta').textContent = statusInfo.eta;
        
        // Update tracking steps
        updateTrackingSteps(statusInfo.step, status);
        
        return statusInfo;
    }

    function updateTrackingSteps(activeStep, status) {
        const steps = document.querySelectorAll('.tracking-step');
        
        // Show/hide delivery step based on order type
        const isDelivery = status === 'out-for-delivery' || 
                          (status === 'ready' && currentOrderData.deliveryMode === 'delivery');
        
        if (isDelivery) {
            document.getElementById('step-delivery').classList.remove('hidden');
            document.getElementById('step-pickup').classList.add('hidden');
        } else {
            document.getElementById('step-delivery').classList.add('hidden');
            document.getElementById('step-pickup').classList.remove('hidden');
        }
        
        // Update step colors
        steps.forEach((step, index) => {
            const stepDiv = step.querySelector('.step-icon');
            stepDiv.classList.remove('bg-green-500', 'bg-gray-100', 'text-white', 'text-gray-400');
            
            if (index < activeStep) {
                stepDiv.classList.add('bg-green-500', 'text-white');
                step.classList.add('completed');
                step.classList.remove('active');
            } else if (index === activeStep) {
                stepDiv.classList.add('bg-green-500', 'text-white');
                step.classList.add('active');
                step.classList.remove('completed');
            } else {
                stepDiv.classList.add('bg-gray-100', 'text-gray-400');
                step.classList.remove('active', 'completed');
            }
        });
    }

    function updateOrderSummary(orderData) {
        const container = document.getElementById('order-summary');
        let html = '';
        
        if (orderData.items && orderData.items.length > 0) {
            orderData.items.forEach(item => {
                const quantity = parseInt(item.quantity) || 1;
                const unitPrice = parseFloat(item.unitPrice) || 0;
                const totalPrice = unitPrice * quantity;
                
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <p class="font-medium">${item.name || 'Food Item'}</p>
                            <p class="text-sm text-gray-600">Quantity: ${quantity} √ó ${getPackName(item.pack)}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold">‚Çπ${totalPrice.toFixed(2)}</p>
                            <p class="text-sm text-gray-500">‚Çπ${unitPrice.toFixed(2)} each</p>
                        </div>
                    </div>
                `;
            });
            
            const total = orderData.totalAmount || orderData.amount || 0;
            
            // Calculate delivery fee breakdown for delivery orders
            if (orderData.deliveryMode === 'delivery') {
                const platformFee = total * 0.05;
                const gstOnPlatform = platformFee * 0.18;
                const riderEarnings = platformFee + gstOnPlatform;
                
                html += `
                    <div class="border-t pt-4 mt-4 space-y-2">
                        <div class="flex justify-between">
                            <span>Subtotal:</span>
                            <span>‚Çπ${parseFloat(total).toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Platform Fee (5%):</span>
                            <span>‚Çπ${platformFee.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>GST on Platform (18%):</span>
                            <span>‚Çπ${gstOnPlatform.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between font-bold text-green-600">
                            <span>Rider Earnings:</span>
                            <span>‚Çπ${riderEarnings.toFixed(2)}</span>
                        </div>
                `;
                
                if (orderData.waitingBonus) {
                    html += `
                        <div class="flex justify-between font-bold text-orange-600">
                            <span>Waiting Bonus:</span>
                            <span>+‚Çπ${orderData.waitingBonus.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                html += `
                        <div class="flex justify-between items-center border-t pt-2">
                            <span class="font-bold text-lg">Total Amount</span>
                            <span class="font-bold text-2xl text-green-600">‚Çπ${parseFloat(total).toFixed(2)}</span>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="border-t pt-4 mt-4">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-lg">Total Amount</span>
                            <span class="font-bold text-2xl text-green-600">‚Çπ${parseFloat(total).toFixed(2)}</span>
                        </div>
                    </div>
                `;
            }
        } else {
            html = '<p class="text-gray-500">Loading order details...</p>';
        }
        
        container.innerHTML = html;
    }

    function updateCustomerDetails(orderData) {
        const container = document.getElementById('customer-details');
        
        let html = `
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-gray-600">Name:</span>
                    <span class="font-bold">${orderData.customerName || orderData.name || '--'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Phone:</span>
                    <span class="font-bold">${orderData.customerPhone || orderData.phone || '--'}</span>
                </div>
        `;
        
        if (orderData.address) {
            html += `
                <div class="flex justify-between">
                    <span class="text-gray-600">Address:</span>
                    <span class="font-bold text-right">${orderData.address.substring(0, 40)}...</span>
                </div>
            `;
        }
        
        html += `
                <div class="flex justify-between">
                    <span class="text-gray-600">Order Type:</span>
                    <span class="font-bold">${orderData.deliveryMode === 'delivery' ? 'üõµ Home Delivery' : 'üè™ Takeaway'}</span>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }

    function addStatusUpdate(orderData) {
        const updatesContainer = document.getElementById('status-updates');
        const status = orderData.status;
        const timestamp = orderData.lastUpdated || Date.now();
        
        const messages = {
            'pending': { 
                title: 'Order Received', 
                message: 'Order received and waiting for restaurant confirmation', 
                icon: 'üì¶', 
                color: 'bg-yellow-500' 
            },
            'confirmed': { 
                title: 'Payment Confirmed', 
                message: 'Payment received and order confirmed', 
                icon: '‚úÖ', 
                color: 'bg-green-500' 
            },
            'preparing': { 
                title: 'Food Preparation Started', 
                message: 'Chef is preparing your delicious food', 
                icon: 'üë®‚Äçüç≥', 
                color: 'bg-blue-500' 
            },
            'ready': { 
                title: 'Ready for Pickup', 
                message: 'Your order is ready at the restaurant', 
                icon: 'üè™', 
                color: 'bg-orange-500' 
            },
            'out-for-delivery': { 
                title: 'Out for Delivery', 
                message: 'Your order is on the way!', 
                icon: 'üõµ', 
                color: 'bg-purple-500' 
            },
            'rider_arrived_restaurant': {
                title: 'Rider Arrived at Restaurant',
                message: 'Delivery partner has arrived at restaurant',
                icon: 'üìç',
                color: 'bg-blue-500'
            },
            'rider_picked_up': {
                title: 'Order Picked Up',
                message: 'Delivery partner has picked up your order',
                icon: 'üì¶',
                color: 'bg-green-500'
            },
            'rider_arrived_customer': {
                title: 'Rider Arrived at Your Location',
                message: 'Delivery partner has arrived at your location',
                icon: 'üìç',
                color: 'bg-blue-500'
            },
            'delivered': { 
                title: 'Order Delivered', 
                message: 'Your order has been delivered successfully', 
                icon: '‚úÖ', 
                color: 'bg-green-500' 
            },
            'cancelled': { 
                title: 'Order Cancelled', 
                message: 'Your order has been cancelled', 
                icon: '‚ùå', 
                color: 'bg-red-500' 
            }
        };
        
        // Check for rider-specific updates
        if (orderData.riderArrivedAt && !updatesContainer.textContent.includes('Rider Arrived at Restaurant')) {
            const riderMessage = messages['rider_arrived_restaurant'];
            addTimelineUpdate(updatesContainer, riderMessage, orderData.riderArrivedAt);
        }
        
        if (orderData.pickedUpAt && !updatesContainer.textContent.includes('Order Picked Up')) {
            const riderMessage = messages['rider_picked_up'];
            addTimelineUpdate(updatesContainer, riderMessage, orderData.pickedUpAt);
        }
        
        if (orderData.riderArrivedCustomerAt && !updatesContainer.textContent.includes('Rider Arrived at Your Location')) {
            const riderMessage = messages['rider_arrived_customer'];
            addTimelineUpdate(updatesContainer, riderMessage, orderData.riderArrivedCustomerAt);
        }
        
        const message = messages[status];
        if (message) {
            addTimelineUpdate(updatesContainer, message, timestamp);
        }
    }

    function addTimelineUpdate(container, message, timestamp) {
        const time = new Date(timestamp).toLocaleTimeString('en-IN', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        const updateHTML = `
            <div class="status-entry flex items-start gap-4">
                <div class="w-8 h-8 rounded-full ${message.color} flex items-center justify-center text-white">
                    ${message.icon}
                </div>
                <div>
                    <p class="font-bold">${message.title}</p>
                    <p class="text-sm text-gray-600">${message.message}</p>
                    <p class="text-xs text-gray-500">${time}</p>
                </div>
            </div>
        `;
        
        // Check if this status already exists
        const existingUpdates = container.querySelectorAll('.status-entry');
        const alreadyExists = Array.from(existingUpdates).some(update => 
            update.textContent.includes(message.title)
        );
        
        if (!alreadyExists) {
            // Add to top
            container.insertAdjacentHTML('afterbegin', updateHTML);
            
            // Limit to 8 updates
            const updates = container.querySelectorAll('.status-entry');
            if (updates.length > 8) {
                updates[updates.length - 1].remove();
            }
        }
    }

    function getPackName(pack) {
        const names = {
            'piece': 'Piece',
            'standard': 'Standard',
            'family': 'Family Pack',
            'xl': 'Extra Large'
        };
        return names[pack] || pack || 'Standard';
    }

    // ==================== COMPLETED/CANCELLED MESSAGES ====================
    function showDeliveredMessage() {
        document.getElementById('after-delivery').classList.remove('hidden');
        
        // Stop all timers and listeners
        if (orderListener) {
            orderListener.off();
        }
        if (countdownTimer) clearInterval(countdownTimer);
        if (waitingChargeInterval) clearInterval(waitingChargeInterval);
        if (riderLocationInterval) clearInterval(riderLocationInterval);
        
        // Show delivery confirmation message
        showNotification('success', 'Order Delivered!', 'Your order has been successfully delivered.');
    }

    function showCancelledMessage(orderData) {
        document.getElementById('order-cancelled').classList.remove('hidden');
        
        if (orderData.cancelReason) {
            document.getElementById('order-cancelled').querySelector('p.text-xl').textContent = 
                `We're sorry, but your order has been cancelled. Reason: ${orderData.cancelReason}`;
        }
        
        if (orderData.refundId) {
            document.getElementById('refund-id').textContent = orderData.refundId;
        }
        
        // Stop all timers and listeners
        if (orderListener) {
            orderListener.off();
        }
        if (countdownTimer) clearInterval(countdownTimer);
        if (waitingChargeInterval) clearInterval(waitingChargeInterval);
        if (riderLocationInterval) clearInterval(riderLocationInterval);
        
        showNotification('error', 'Order Cancelled', 'Your order has been cancelled. Refund will be processed.');
    }

    function initiateRefund(orderData, reason) {
        // Create refund record in Firebase
        const refundData = {
            orderId: orderData.orderId || currentOrderId,
            paymentId: orderData.razorpayPaymentId,
            amount: orderData.totalAmount,
            customerName: orderData.customerName,
            customerPhone: orderData.customerPhone,
            status: 'pending',
            initiatedAt: Date.now(),
            expectedDate: Date.now() + 5 * 24 * 60 * 60 * 1000, // 5 days from now
            reason: reason
        };
        
        const refundId = 'refund_' + Date.now();
        
        database.ref('refunds/' + refundId).set(refundData)
            .then(() => {
                console.log("Refund initiated");
                // Update order with refund ID
                database.ref('orders/' + currentOrderId).update({
                    refundId: refundId,
                    refundInitiatedAt: Date.now()
                });
                
                // Simulate refund processing (in real app, this would call Razorpay API)
                setTimeout(() => {
                    database.ref('refunds/' + refundId).update({
                        status: 'processed',
                        processedAt: Date.now()
                    });
                }, 2000);
            })
            .catch(error => {
                console.error("Error initiating refund:", error);
            });
    }

    function showEmptyOrderOverlay() {
        document.getElementById('emptyOrderOverlay').classList.remove('hidden');
        
        // Hide main content
        document.querySelector('.max-w-6xl').style.display = 'none';
        document.querySelector('footer').style.display = 'none';
        document.querySelector('header').style.display = 'none';
        
        // Start countdown
        let seconds = 5;
        const countdownElement = document.getElementById('redirect-countdown');
        countdownElement.textContent = seconds;
        
        const countdown = setInterval(() => {
            seconds--;
            countdownElement.textContent = seconds;
            
            if (seconds <= 0) {
                clearInterval(countdown);
                window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/';
            }
        }, 1000);
    }

    // ==================== NOTIFICATION FUNCTIONS ====================
    function showNotification(type, title, message) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 bg-white rounded-xl shadow-xl p-4 max-w-sm border-l-4 ${
            type === 'success' ? 'border-green-500' :
            type === 'error' ? 'border-red-500' :
            type === 'warning' ? 'border-yellow-500' :
            'border-blue-500'
        }`;
        
        notification.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="text-xl">
                    ${type === 'success' ? '‚úÖ' :
                      type === 'error' ? '‚ùå' :
                      type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                </span>
                <div>
                    <p class="font-bold">${title}</p>
                    <p class="text-sm text-gray-600">${message}</p>
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // ==================== SHARE OTP FUNCTION ====================
    document.getElementById('share-otp').addEventListener('click', function() {
        const otp = document.getElementById('otp-display').textContent;
        const orderId = document.getElementById('order-id-display').textContent;
        const orderData = currentOrderData;
        
        if (!otp || otp === 'XXXXXX') {
            alert('OTP not available yet. Please wait for order confirmation.');
            return;
        }
        
        const message = `‚úÖ *OTP VERIFICATION* ‚úÖ%0A%0AOrder ID: ${orderId}%0AOTP: ${otp}%0A%0AOTP verified successfully!%0A%0AOrder Details:%0A- Customer: ${orderData.customerName}%0A- Amount: ‚Çπ${orderData.totalAmount}%0A- Items: ${orderData.items ? orderData.items.length : 0}`;
        
        // Open WhatsApp with pre-filled message
        window.open(`https://wa.me/917651837322?text=${message}`, '_blank');
        
        // Also show notification to customer
        alert('OTP shared with EasyGo! WhatsApp will open with OTP details.');
        
        // Log the OTP sharing in Firebase
        if (currentOrderId) {
            database.ref('orders/' + currentOrderId).update({
                otpSharedAt: Date.now(),
                lastUpdated: Date.now()
            });
        }
    });

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('EasyGo Track Page - Loading...');
        
        // Initialize Firebase
        initializeFirebase();
        
        // Wait for Firebase connection, then load order
        const checkConnection = setInterval(() => {
            if (isFirebaseConnected) {
                clearInterval(checkConnection);
                loadOrderData();
            }
        }, 500);
        
        // Fallback: Load order after 3 seconds even if Firebase not connected
        setTimeout(() => {
            if (!isFirebaseConnected) {
                console.warn('Firebase not connected, using localStorage fallback');
                loadOrderDataFromLocalStorage();
            }
        }, 3000);
        
        // Add refresh button (for debugging)
        const refreshBtn = document.createElement('button');
        refreshBtn.innerHTML = 'üîÑ Refresh';
        refreshBtn.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-blue-600 transition z-40';
        refreshBtn.onclick = () => location.reload();
        document.body.appendChild(refreshBtn);
    });

    function loadOrderData() {
        const orderId = getOrderIdFromLocalStorage();
        
        if (!orderId) {
            console.log('No order ID found');
            showEmptyOrderOverlay();
            return;
        }
        
        console.log('Loading order:', orderId);
        
        // Setup real-time listener
        const listenerSet = setupOrderListener(orderId);
        
        if (!listenerSet) {
            // Fallback to loading from localStorage
            loadOrderDataFromLocalStorage();
        }
    }

    function loadOrderDataFromLocalStorage() {
        const orderData = JSON.parse(localStorage.getItem('easygo-last-order') || 'null');
        const orderId = localStorage.getItem('easygo-order-id');
        
        if (!orderData && !orderId) {
            showEmptyOrderOverlay();
            return;
        }
        
        if (orderData) {
            currentOrderData = orderData;
            updateOrderUI(orderData);
            initMap();
            
            // Update map if we have customer location
            if (orderData.customerLocation) {
                updateMap(orderData);
            }
        } else {
            // Minimal UI with just order ID
            document.getElementById('order-id-display').textContent = orderId;
            document.getElementById('order-status-badge').innerHTML = 
                `<span class="text-xl">‚è≥</span><span class="font-bold">Connecting to server...</span>`;
        }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (orderListener) {
            orderListener.off();
        }
        if (countdownTimer) clearInterval(countdownTimer);
        if (waitingChargeInterval) clearInterval(waitingChargeInterval);
        if (riderLocationInterval) clearInterval(riderLocationInterval);
        if (acceptedTimer) clearInterval(acceptedTimer);
    });

    // For debugging/testing
    window.simulateStatusUpdate = function(status) {
        if (!currentOrderId) {
            alert('No order ID found');
            return;
        }
        
        if (isFirebaseConnected) {
            const updates = {
                status: status,
                lastUpdated: Date.now()
            };
            
            // Add timestamps for specific statuses
            switch(status) {
                case 'confirmed':
                    updates.confirmedAt = Date.now();
                    break;
                case 'preparing':
                    updates.preparingAt = Date.now();
                    break;
                case 'ready':
                    updates.readyAt = Date.now();
                    break;
                case 'out-for-delivery':
                    updates.outForDeliveryAt = Date.now();
                    updates.deliveryPartner = 'Test Rider';
                    updates.deliveryPartnerPhone = '9876543210';
                    updates.riderId = 'test_rider_' + Date.now();
                    break;
                case 'delivered':
                    updates.deliveredAt = Date.now();
                    break;
            }
            
            database.ref('orders/' + currentOrderId).update(updates);
            alert(`Status updated to: ${status}`);
        } else {
            alert('Firebase not connected');
        }
    };
    
    // Test rider location simulation
    window.simulateRiderLocation = function(lat, lng) {
        if (!currentOrderData || !currentOrderData.riderId) {
            alert('No rider assigned to current order');
            return;
        }
        
        if (isFirebaseConnected) {
            database.ref('riders/' + currentOrderData.riderId + '/location').set({
                lat: lat || 22.7767737,
                lng: lng || 75.9605483,
                updatedAt: Date.now()
            });
            alert('Rider location updated');
        } else {
            alert('Firebase not connected');
        }
    };
    </script>
</body>
</html>
